<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶å®šä½è½¨è¿¹è¿½è¸ª</title>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=19pC14ldf5XgThjPKscZQwIFfyV1ZYOQ"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
        }
        #map {
            width: 100%;
            height: 70vh;
        }
        .controls {
            padding: 15px;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn.active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .btn.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        .stat-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }
        .stat-card h3 {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }
        .stat-card p {
            font-size: 16px;
            color: #333;
            font-weight: bold;
        }
        .log {
            margin-top: 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 4px;
            border-left: 3px solid #007bff;
            background: white;
        }
        .log-entry.success { border-left-color: #28a745; }
        .log-entry.error { border-left-color: #dc3545; }
        .log-entry.warning { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="controls">
        <div class="button-group">
            <button id="startBtn" class="btn">ğŸ¯ å¼€å§‹è¿½è¸ª</button>
            <button id="stopBtn" class="btn">â¹ï¸ åœæ­¢è¿½è¸ª</button>
            <button id="clearBtn" class="btn secondary">ğŸ—‘ï¸ æ¸…é™¤è½¨è¿¹</button>
            <button id="centerBtn" class="btn secondary">ğŸ“ å›åˆ°å½“å‰ä½ç½®</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>çŠ¶æ€</h3>
                <p id="status">æœªå¼€å§‹</p>
            </div>
            <div class="stat-card">
                <h3>æ›´æ–°æ¬¡æ•°</h3>
                <p id="updateCount">0</p>
            </div>
            <div class="stat-card">
                <h3>æ€»è·ç¦»</h3>
                <p id="totalDistance">0 m</p>
            </div>
            <div class="stat-card">
                <h3>å½“å‰é€Ÿåº¦</h3>
                <p id="currentSpeed">-</p>
            </div>
            <div class="stat-card">
                <h3>ç²¾åº¦</h3>
                <p id="currentAccuracy">-</p>
            </div>
            <div class="stat-card">
                <h3>è½¨è¿¹ç‚¹æ•°</h3>
                <p id="pointCount">0</p>
            </div>
        </div>

        <div class="log" id="logContainer">
            <div class="log-entry">ç­‰å¾…å¼€å§‹è¿½è¸ª...</div>
        </div>
    </div>

    <script>
        // åœ°å›¾åˆå§‹åŒ–
        var map = new BMap.Map("map");
        var defaultCenter = new BMap.Point(116.404, 39.915);
        map.centerAndZoom(defaultCenter, 15);
        map.enableScrollWheelZoom(true);

        // å…¨å±€å˜é‡
        var watchId = null;
        var updateCount = 0;
        var totalDistance = 0;
        var pathPoints = [];
        var lastPosition = null;
        var currentMarker = null;
        var accuracyCircle = null;
        var polyline = null;
        var isTracking = false;

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            var logContainer = document.getElementById('logContainer');
            var entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            var timestamp = new Date().toLocaleTimeString();
            entry.textContent = '[' + timestamp + '] ' + message;
            logContainer.insertBefore(entry, logContainer.firstChild);
        }

        // è®¡ç®—ä¸¤ç‚¹é—´è·ç¦»ï¼ˆç±³ï¼‰
        function calculateDistance(lat1, lng1, lat2, lng2) {
            var R = 6371000; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // æ ¼å¼åŒ–è·ç¦»æ˜¾ç¤º
        function formatDistance(meters) {
            if (meters < 1000) {
                return meters.toFixed(1) + ' m';
            } else {
                return (meters / 1000).toFixed(2) + ' km';
            }
        }

        // æ›´æ–°åœ°å›¾ä¸Šçš„ä½ç½®æ ‡è®°
        function updateMapMarker(lat, lng, accuracy) {
            var point = new BMap.Point(lng, lat);

            // æ›´æ–°æ ‡è®°
            if (currentMarker) {
                map.removeOverlay(currentMarker);
            }
            currentMarker = new BMap.Marker(point);
            map.addOverlay(currentMarker);

            // æ›´æ–°ç²¾åº¦åœˆ
            if (accuracyCircle) {
                map.removeOverlay(accuracyCircle);
            }
            accuracyCircle = new BMap.Circle(point, accuracy, {
                strokeColor: "#4CAF50",
                strokeWeight: 2,
                strokeOpacity: 0.5,
                fillColor: "#4CAF50",
                fillOpacity: 0.2
            });
            map.addOverlay(accuracyCircle);

            return point;
        }

        // æ›´æ–°è½¨è¿¹çº¿
        function updateTrackLine() {
            if (pathPoints.length < 2) return;

            if (polyline) {
                map.removeOverlay(polyline);
            }

            polyline = new BMap.Polyline(pathPoints, {
                strokeColor: "#FF6B6B",
                strokeWeight: 4,
                strokeOpacity: 0.8
            });
            map.addOverlay(polyline);

            // åœ¨è½¨è¿¹èµ·ç‚¹æ·»åŠ æ ‡è®°
            if (pathPoints.length === 2) {
                var startMarker = new BMap.Marker(pathPoints[0], {
                    icon: new BMap.Icon(
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iMTAiIGZpbGw9IiM0Q0FGNTAiLz48L3N2Zz4=',
                        new BMap.Size(24, 24)
                    )
                });
                map.addOverlay(startMarker);
            }
        }

        // å¤„ç†ä½ç½®æ›´æ–°
        function handlePositionUpdate(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var accuracy = position.coords.accuracy;
            var speed = position.coords.speed;
            var heading = position.coords.heading;

            updateCount++;

            // æ›´æ–°åœ°å›¾æ ‡è®°
            var point = updateMapMarker(lat, lng, accuracy);
            
            // æ·»åŠ åˆ°è½¨è¿¹ç‚¹
            pathPoints.push(point);

            // è®¡ç®—ç§»åŠ¨è·ç¦»
            var distance = 0;
            if (lastPosition) {
                distance = calculateDistance(
                    lastPosition.lat,
                    lastPosition.lng,
                    lat,
                    lng
                );
                
                // åªæœ‰ç§»åŠ¨è·ç¦»å¤§äºç²¾åº¦çš„ä¸€åŠæ—¶æ‰ç´¯åŠ ï¼ˆå‡å°‘GPSæ¼‚ç§»å½±å“ï¼‰
                if (distance > accuracy / 2) {
                    totalDistance += distance;
                }
            }

            // æ›´æ–°è½¨è¿¹çº¿
            updateTrackLine();

            // ç§»åŠ¨åœ°å›¾è§†è§’åˆ°å½“å‰ä½ç½®
            map.panTo(point);

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('updateCount').textContent = updateCount;
            document.getElementById('totalDistance').textContent = formatDistance(totalDistance);
            document.getElementById('pointCount').textContent = pathPoints.length;
            document.getElementById('currentAccuracy').textContent = 'Â±' + Math.round(accuracy) + 'm';
            
            if (speed !== null && speed !== undefined && speed > 0) {
                document.getElementById('currentSpeed').textContent = (speed * 3.6).toFixed(1) + ' km/h';
            } else {
                document.getElementById('currentSpeed').textContent = '-';
            }

            // æ·»åŠ æ—¥å¿—
            var message = 'âœ… #' + updateCount + ': ' +
                lat.toFixed(6) + ', ' + lng.toFixed(6) +
                ' (Â±' + Math.round(accuracy) + 'm)';
            
            if (distance > 0) {
                message += ' | ç§»åŠ¨: ' + distance.toFixed(1) + 'm';
            }
            
            if (speed !== null && speed !== undefined && speed > 0) {
                message += ' | é€Ÿåº¦: ' + (speed * 3.6).toFixed(1) + 'km/h';
            }

            addLog(message, 'success');

            lastPosition = {lat: lat, lng: lng};
        }

        // å¤„ç†å®šä½é”™è¯¯
        function handlePositionError(error) {
            var errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'âŒ ç”¨æˆ·æ‹’ç»äº†å®šä½è¯·æ±‚';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'âŒ ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'âŒ è¯·æ±‚è¶…æ—¶';
                    break;
                default:
                    errorMsg = 'âŒ æœªçŸ¥é”™è¯¯: ' + error.message;
            }
            addLog(errorMsg, 'error');
            document.getElementById('status').textContent = 'å®šä½å¤±è´¥';
        }

        // å¼€å§‹è¿½è¸ª
        function startTracking() {
            if (!navigator.geolocation) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½');
                addLog('âŒ æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½', 'error');
                return;
            }

            if (isTracking) {
                addLog('âš ï¸ å·²åœ¨è¿½è¸ªä¸­', 'warning');
                return;
            }

            addLog('ğŸ¯ å¼€å§‹ä½ç½®è¿½è¸ª...', 'success');
            document.getElementById('status').textContent = 'è¿½è¸ªä¸­';
            document.getElementById('startBtn').classList.add('active');
            isTracking = true;

            watchId = navigator.geolocation.watchPosition(
                handlePositionUpdate,
                handlePositionError,
                {
                    enableHighAccuracy: true,
                    timeout: 27000,
                    maximumAge: 0
                }
            );

            addLog('âš™ï¸ é…ç½®: é«˜ç²¾åº¦æ¨¡å¼, è¶…æ—¶27s', 'info');
        }

        // åœæ­¢è¿½è¸ª
        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                isTracking = false;
                
                addLog('â¹ï¸ è¿½è¸ªå·²åœæ­¢ã€‚æ€»è·ç¦»: ' + formatDistance(totalDistance) + 
                       ', æ€»ç‚¹æ•°: ' + pathPoints.length, 'warning');
                
                document.getElementById('status').textContent = 'å·²åœæ­¢';
                document.getElementById('startBtn').classList.remove('active');
            }
        }

        // æ¸…é™¤è½¨è¿¹
        function clearTrack() {
            // æ¸…é™¤åœ°å›¾è¦†ç›–ç‰©
            if (polyline) {
                map.removeOverlay(polyline);
                polyline = null;
            }
            if (currentMarker) {
                map.removeOverlay(currentMarker);
                currentMarker = null;
            }
            if (accuracyCircle) {
                map.removeOverlay(accuracyCircle);
                accuracyCircle = null;
            }

            // æ¸…é™¤æ‰€æœ‰è¦†ç›–ç‰©ï¼ˆåŒ…æ‹¬èµ·ç‚¹æ ‡è®°ï¼‰
            map.clearOverlays();

            // é‡ç½®æ•°æ®
            pathPoints = [];
            totalDistance = 0;
            updateCount = 0;
            lastPosition = null;

            // é‡ç½®æ˜¾ç¤º
            document.getElementById('updateCount').textContent = '0';
            document.getElementById('totalDistance').textContent = '0 m';
            document.getElementById('pointCount').textContent = '0';
            document.getElementById('currentSpeed').textContent = '-';
            document.getElementById('currentAccuracy').textContent = '-';

            addLog('ğŸ—‘ï¸ è½¨è¿¹å·²æ¸…é™¤', 'info');
        }

        // å›åˆ°å½“å‰ä½ç½®
        function centerToCurrentPosition() {
            if (lastPosition) {
                var point = new BMap.Point(lastPosition.lng, lastPosition.lat);
                map.panTo(point);
                addLog('ğŸ“ å·²å›åˆ°å½“å‰ä½ç½®', 'info');
            } else {
                addLog('âš ï¸ è¿˜æ²¡æœ‰ä½ç½®ä¿¡æ¯', 'warning');
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('startBtn').addEventListener('click', startTracking);
        document.getElementById('stopBtn').addEventListener('click', stopTracking);
        document.getElementById('clearBtn').addEventListener('click', clearTrack);
        document.getElementById('centerBtn').addEventListener('click', centerToCurrentPosition);

        // é¡µé¢å…³é—­æ—¶åœæ­¢è¿½è¸ª
        window.addEventListener('beforeunload', stopTracking);

        // åˆå§‹åŒ–æç¤º
        addLog('ğŸ’¡ ç‚¹å‡»"å¼€å§‹è¿½è¸ª"æŒ‰é’®å¼€å§‹è®°å½•æ‚¨çš„ç§»åŠ¨è½¨è¿¹', 'info');
        addLog('ğŸ’¡ çº¢è‰²çº¿æ¡æ˜¾ç¤ºæ‚¨çš„ç§»åŠ¨è·¯å¾„ï¼Œç»¿è‰²åœ†åœˆè¡¨ç¤ºå®šä½ç²¾åº¦', 'info');
    </script>
</body>
</html>
