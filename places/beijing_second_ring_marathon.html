<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—äº¬äºŒç¯é©¬æ‹‰æ¾è·¯çº¿è§„åˆ’ - ä»è¥¿ç›´é—¨å‡ºå‘</title>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=19pC14ldf5XgThjPKscZQwIFfyV1ZYOQ"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .info-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .info-panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
            border-left: 4px solid #667eea;
            padding-left: 10px;
        }
        .route-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .info-card {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        .info-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .info-card p {
            font-size: 20px;
            color: #333;
            font-weight: bold;
        }
        .checkpoints {
            margin-top: 15px;
        }
        .checkpoint-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .checkpoint-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .checkpoint-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .checkpoint-name {
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }
        .checkpoint-distance {
            color: #666;
            font-size: 14px;
            margin-left: auto;
        }
        .toilet-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            margin-bottom: 10px;
            background: #fff3cd;
            border-radius: 6px;
            border-left: 3px solid #ffc107;
        }
        .toilet-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        .toilet-info {
            flex: 1;
        }
        .toilet-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        .toilet-address {
            color: #666;
            font-size: 13px;
        }
        #map {
            width: 100%;
            height: 700px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        .map-search-container {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .map-search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        .map-search-input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .map-search-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .map-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .map-search-btn:active {
            transform: translateY(0);
        }
        .search-result-panel {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        .search-result-item:hover {
            background: #f5f5f5;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        .search-result-address {
            font-size: 12px;
            color: #666;
        }
        .location-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        .location-btn:active {
            transform: translateY(0);
        }
        .location-btn.active {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .location-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            font-size: 14px;
        }
        .location-info.show {
            display: block;
        }
        .location-info strong {
            color: #1976d2;
        }
        .location-accuracy {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .legend-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        .tips {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        .tips h3 {
            color: #0c5460;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .tips ul {
            margin-left: 20px;
            color: #0c5460;
        }
        .tips li {
            margin-bottom: 5px;
        }
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ff6b6b;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        .warning-box h3 {
            color: #ff6b6b;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .warning-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 3px solid #ff6b6b;
        }
        .warning-item h4 {
            color: #ff6b6b;
            margin-bottom: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .warning-number {
            background: #ff6b6b;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 8px;
            font-size: 12px;
        }
        .warning-item p {
            color: #666;
            font-size: 13px;
            margin: 0;
            line-height: 1.6;
        }
        .route-direction {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .route-direction h3 {
            color: #28a745;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .route-direction p {
            color: #155724;
            margin: 5px 0;
            line-height: 1.6;
        }
        .route-direction strong {
            color: #28a745;
        }
        
        /* å¤šäººä½ç½®å…±äº«æ ·å¼ */
        .share-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .share-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .nickname-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }
        .nickname-input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .share-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .share-btn.active {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .online-users {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .online-users h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #666;
        }
        .user-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
        }
        .user-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .user-name {
            flex: 1;
            font-weight: bold;
            color: #333;
        }
        .user-distance {
            color: #666;
            font-size: 12px;
        }
        .firebase-status {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding: 6px 10px;
            background: #e3f2fd;
            border-radius: 4px;
            text-align: center;
        }
        .firebase-status.connected {
            background: #d4edda;
            color: #155724;
        }
        .firebase-status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸƒ åŒ—äº¬äºŒç¯é©¬æ‹‰æ¾è·¯çº¿è§„åˆ’</h1>
        <p>èµ·ç‚¹ï¼šè¥¿ç›´é—¨ | å…¨ç¨‹çº¦32.7å…¬é‡Œï¼ˆå®é™…çº¦33.4kmï¼‰ | æ²¿äºŒç¯è·¯è¾…è·¯ | ç»è¿‡29åº§ç«‹äº¤æ¡¥</p>
    </div>

    <div class="container">
        <div class="info-panel">
            <div class="route-direction">
                <h3>ğŸ§­ è·¯çº¿è¯´æ˜ï¼šåŒ—äº¬äºŒç¯è·¯å®Œæ•´ç¯çº¿ï¼ˆ32.7å…¬é‡Œï¼‰</h3>
                <p><strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>æ°¸å®šé—¨ã€å³å®‰é—¨ã€å·¦å®‰é—¨ã€å¹¿æ¸ é—¨ã€ä¸œä¾¿é—¨ã€è¥¿ä¾¿é—¨ã€å¹¿å®‰é—¨è™½ç„¶æ˜¯å¤ä»£"å¤–ä¸ƒé—¨"ï¼Œä½†å®ƒä»¬çš„<strong>æ»¨æ²³è·¯æ®µç¡®å®æ˜¯ç°ä»£äºŒç¯è·¯çš„ç»„æˆéƒ¨åˆ†</strong>ï¼äºŒç¯è·¯æ²¿æŠ¤åŸæ²³ä¿®å»ºï¼Œå—æ®µå’Œä¸œå—æ®µéƒ½æ˜¯æ»¨æ²³è·¯ã€‚</p>
                <p><strong>é¡ºæ—¶é’ˆæ–¹å‘ï¼š</strong>ä»è¥¿ç›´é—¨å‡ºå‘ï¼Œå…ˆå‘ä¸œï¼ˆå¾·èƒœé—¨â†’å®‰å®šé—¨â†’ä¸œç›´é—¨â†’æœé˜³é—¨ï¼‰ï¼Œå†å‘å—ï¼ˆå»ºå›½é—¨â†’ä¸œä¾¿é—¨â†’å¹¿æ¸ é—¨â†’å·¦å®‰é—¨ï¼‰ï¼Œç„¶åå‘è¥¿ï¼ˆæ°¸å®šé—¨â†’å³å®‰é—¨â†’å¹¿å®‰é—¨â†’è¥¿ä¾¿é—¨ï¼‰ï¼Œæœ€åå‘åŒ—ï¼ˆå¤å…´é—¨â†’é˜œæˆé—¨ï¼‰å›åˆ°è¥¿ç›´é—¨ã€‚</p>
                
                <p><strong>ğŸŒ³ è¥¿äºŒç¯ï¼ˆçº¦8kmï¼‰ï¼š</strong>åŸå¸‚ç»¿é“ç³»ç»Ÿï¼Œæœ‰å¡‘èƒ¶è·‘é“+åœ°ç –åŒå±‚è®¾è®¡ï¼Œé‡‘èè¡—åŒºåŸŸæœ‰æ ‡å‡†ç™¾ç±³èµ›é“ã€‚æ ‘è«è¦†ç›–ï¼Œç©ºæ°”æ¸…æ–°ã€‚</p>
                
                <p><strong>ğŸï¸ åŒ—æŠ¤åŸæ²³ï¼ˆçº¦6.4kmï¼‰ï¼š</strong>å¤ªå¹³æ¹–â†’ä¸œç›´é—¨ï¼Œå…¨é•¿6.36å…¬é‡Œã€‚æœ‰è·é£è½©ã€æµ®çƒŸèˆ«ã€ç›ˆç‰æ´²ç­‰å›­æ—å°å“ï¼Œæœ¨æ ˆé“ã€ä¹æ›²æ¡¥ï¼Œå¤å­£è·èŠ±ç››å¼€ã€‚<span style="color:#28a745;font-weight:bold;">æœ€ç¾æ»¨æ°´æ­¥é“ï¼</span></p>
                
                <p><strong>ğŸ›ï¸ ä¸œäºŒç¯ï¼ˆçº¦8kmï¼‰ï¼š</strong>å»ºå›½é—¨åˆ°ä¸œä¾¿é—¨æ®µæœ‰æ˜åŸå¢™é—å€å…¬å›­ï¼Œå¤æœ´æ­¥é“ï¼Œå¯è§‚èµå¤è§‚è±¡å°å’Œæ˜åŸå¢™ã€‚å…¶ä»–è·¯æ®µä¸ºåŸå¸‚ç»¿é“ã€‚</p>
                
                <p><strong>ğŸŒŠ å—äºŒç¯+ä¸œå—æ®µï¼ˆçº¦10kmï¼‰ï¼š</strong>æŠ¤åŸæ²³ç»¿é“å…¨ç¨‹ä¼´éšï¼Œ<span style="color:#ff6b6b;font-weight:bold;">ä¸€å®šè¦ä»é©¬è·¯ä¸‹åˆ°æ²³å ¤ç»¿é“ä¸Šè·‘</span>ã€‚æœ‰äºŒåå››èŠ‚æ°”å…¬å›­ã€å·¦å®‰é—¨è§’æ¥¼ã€ç™¾ç±³æ¢…å»Šç­‰æ™¯ç‚¹ã€‚ç»¿æ ‘æˆè«ï¼Œæ²³æ™¯ä¼˜ç¾ã€‚</p>
                
                <p><strong>âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</strong>åŒ—äºŒç¯éƒ¨åˆ†è·¯æ®µéœ€è¿‡çº¢ç»¿ç¯ï¼Œå»ºè®®æ—©æ™¨5:30-7:00å‡ºå‘é¿å¼€è½¦æµã€‚éƒ¨åˆ†æ¡¥ä¸‹é€šé“å…‰çº¿è¾ƒæš—ï¼Œæ³¨æ„å®‰å…¨ã€‚</p>
            </div>
        </div>

        <div class="info-panel">
            <h2>ğŸ“Š è·¯çº¿æ¦‚å†µ</h2>
            <div class="route-info">
                <div class="info-card">
                    <h3>æ€»è·ç¦»</h3>
                    <p>33 km</p>
                </div>
                <div class="info-card">
                    <h3>èµ·ç‚¹/ç»ˆç‚¹</h3>
                    <p>è¥¿ç›´é—¨</p>
                </div>
                <div class="info-card">
                    <h3>ç»¿é“æ¯”ä¾‹</h3>
                    <p>çº¦80%</p>
                </div>
                <div class="info-card">
                    <h3>å»ºè®®é…é€Ÿ</h3>
                    <p>5:00-5:30/km</p>
                </div>
                <div class="info-card">
                    <h3>é¢„è®¡ç”¨æ—¶</h3>
                    <p>2.5-3å°æ—¶</p>
                </div>
                <div class="info-card">
                    <h3>è·¯é¢ç±»å‹</h3>
                    <p>å¡‘èƒ¶è·‘é“+æ­¥é“</p>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <h2>ğŸš© å…³é”®èŠ‚ç‚¹ï¼ˆé¡ºæ—¶é’ˆæ–¹å‘ï¼‰</h2>
            <div class="checkpoints">
                <div class="checkpoint-item">
                    <div class="checkpoint-number">èµ·</div>
                    <div class="checkpoint-name">è¥¿ç›´é—¨</div>
                    <div class="checkpoint-distance">0 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">1</div>
                    <div class="checkpoint-name">å¾·èƒœé—¨</div>
                    <div class="checkpoint-distance">~2.5 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">2</div>
                    <div class="checkpoint-name">å®‰å®šé—¨</div>
                    <div class="checkpoint-distance">~5 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">3</div>
                    <div class="checkpoint-name">ä¸œç›´é—¨</div>
                    <div class="checkpoint-distance">~7.5 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">4</div>
                    <div class="checkpoint-name">æœé˜³é—¨</div>
                    <div class="checkpoint-distance">~10 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">5</div>
                    <div class="checkpoint-name">å»ºå›½é—¨</div>
                    <div class="checkpoint-distance">~12.5 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">6</div>
                    <div class="checkpoint-name">ä¸œä¾¿é—¨</div>
                    <div class="checkpoint-distance">~15 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">7</div>
                    <div class="checkpoint-name">å¹¿æ¸ é—¨</div>
                    <div class="checkpoint-distance">~17 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">8</div>
                    <div class="checkpoint-name">å·¦å®‰é—¨</div>
                    <div class="checkpoint-distance">~19 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">9</div>
                    <div class="checkpoint-name">æ°¸å®šé—¨</div>
                    <div class="checkpoint-distance">~21 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">10</div>
                    <div class="checkpoint-name">å³å®‰é—¨</div>
                    <div class="checkpoint-distance">~23 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">11</div>
                    <div class="checkpoint-name">å¹¿å®‰é—¨</div>
                    <div class="checkpoint-distance">~25 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">12</div>
                    <div class="checkpoint-name">è¥¿ä¾¿é—¨</div>
                    <div class="checkpoint-distance">~27 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">13</div>
                    <div class="checkpoint-name">å¤å…´é—¨</div>
                    <div class="checkpoint-distance">~29 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">14</div>
                    <div class="checkpoint-name">é˜œæˆé—¨</div>
                    <div class="checkpoint-distance">~31 km</div>
                </div>
                <div class="checkpoint-item">
                    <div class="checkpoint-number">ç»ˆ</div>
                    <div class="checkpoint-name">è¿”å›è¥¿ç›´é—¨</div>
                    <div class="checkpoint-distance">~33 km</div>
                </div>
            </div>
            
            <div class="tips">
                <h3>ğŸ¯ å„è·¯æ®µç‰¹è‰²è¯¦è§£</h3>
                <ul>
                    <li><strong>è¥¿ç›´é—¨â†’å¾·èƒœé—¨â†’å®‰å®šé—¨ï¼ˆ0-5kmï¼‰ï¼š</strong>åŒ—äºŒç¯åŸå¸‚ç»¿é“ï¼Œéœ€è¿‡è¥¿ç›´é—¨æ¡¥ã€å¾·èƒœé—¨æ¡¥ã€å®‰å®šé—¨æ¡¥ã€‚æ—©æ™¨è½¦æµè¾ƒå¤§ï¼Œæ³¨æ„çº¢ç»¿ç¯ã€‚</li>
                    <li><strong>å®‰å®šé—¨â†’ä¸œç›´é—¨ï¼ˆ5-7.5kmï¼‰ï¼š</strong>è¿›å…¥åŒ—æŠ¤åŸæ²³æ»¨æ°´æ­¥é“ï¼ä»å®‰å®šé—¨ä¸œæ»¨æ²³è·¯å¼€å§‹ï¼Œæ²¿æ²³æ™¯è§‚ä¼˜ç¾ï¼Œæœ‰å›­æ—å°å“ã€‚</li>
                    <li><strong>ä¸œç›´é—¨â†’æœé˜³é—¨â†’å»ºå›½é—¨ï¼ˆ7.5-12.5kmï¼‰ï¼š</strong>ä¸œäºŒç¯åŸå¸‚ç»¿é“ï¼Œæœé˜³é—¨ã€å»ºå›½é—¨æ¡¥åŒºè½¦æµå¯†é›†ã€‚</li>
                    <li><strong>å»ºå›½é—¨â†’ä¸œä¾¿é—¨ï¼ˆ12.5-15kmï¼‰ï¼š</strong>æ˜åŸå¢™é—å€å…¬å›­æ®µï¼Œå¤æœ´æ­¥é“ï¼Œå¯è§‚èµå¤è§‚è±¡å°å’Œæ˜åŸå¢™ï¼Œæ–‡åŒ–æ°”æ¯æµ“åšã€‚</li>
                    <li><strong>ä¸œä¾¿é—¨â†’å¹¿æ¸ é—¨â†’å·¦å®‰é—¨ï¼ˆ15-19kmï¼‰ï¼š</strong>ä¸œå—æŠ¤åŸæ²³ç»¿é“ï¼Œ<span style="color:#ff6b6b;font-weight:bold;">è¿‡ä¸œä¾¿é—¨æ¡¥åå°½æ—©ä¸‹åˆ°æ²³å ¤ç»¿é“</span>ï¼Œå¡‘èƒ¶è·‘é“ï¼Œæ™¯è‰²ä¼˜ç¾ã€‚</li>
                    <li><strong>å·¦å®‰é—¨â†’æ°¸å®šé—¨â†’å³å®‰é—¨ï¼ˆ19-23kmï¼‰ï¼š</strong>å—æŠ¤åŸæ²³ç»¿é“ï¼Œæœ‰å·¦å®‰é—¨è§’æ¥¼ã€ç™¾ç±³æ¢…å»Šã€æ°¸å®šé—¨å…¬å›­ï¼Œç»§ç»­æ²¿æ²³å ¤ç»¿é“è·‘ã€‚</li>
                    <li><strong>å³å®‰é—¨â†’å¹¿å®‰é—¨â†’è¥¿ä¾¿é—¨ï¼ˆ23-27kmï¼‰ï¼š</strong>è¥¿å—æŠ¤åŸæ²³ç»¿é“ï¼Œå¹¿å®‰é—¨æ¡¥é™„è¿‘æ°´é¸Ÿä¼—å¤šï¼Œç”Ÿæ€ç¯å¢ƒå¥½ã€‚å¤©å®å¯ºæ¡¥å¤„ç»¿é“ç»“æŸï¼Œä¸Šé©¬è·¯ç»§ç»­å‘åŒ—ã€‚</li>
                    <li><strong>è¥¿ä¾¿é—¨â†’å¤å…´é—¨â†’é˜œæˆé—¨ï¼ˆ27-31kmï¼‰ï¼š</strong>è¥¿äºŒç¯åŸå¸‚ç»¿é“ï¼Œé‡‘èè¡—åŒºåŸŸæœ‰å¡‘èƒ¶è·‘é“å’Œç™¾ç±³èµ›é“ï¼Œæ ‘è«è¦†ç›–ã€‚å¤å…´é—¨èµ°æ¡¥ä¸‹é€šé“ã€‚</li>
                    <li><strong>é˜œæˆé—¨â†’è¥¿ç›´é—¨ï¼ˆ31-33kmï¼‰ï¼š</strong>æœ€åå†²åˆºæ®µï¼Œè¥¿äºŒç¯ç»¿é“ï¼Œå›åˆ°èµ·ç‚¹å®Œæˆå…¨ç¨‹ï¼</li>
                </ul>
            </div>
        </div>

        <div class="info-panel">
            <h2>âš ï¸ äº”ä¸ªæ˜“é”™å…³é”®ç‚¹ï¼ˆå¿…çœ‹ï¼ï¼‰</h2>
            <div class="warning-box">
                <h3>æ ¹æ®è·‘å‹å®æˆ˜ç»éªŒï¼Œä»¥ä¸‹5ä¸ªä½ç½®æœ€å®¹æ˜“è·‘é”™ï¼Œè¯·ç‰¹åˆ«æ³¨æ„ï¼</h3>
                
                <div class="warning-item">
                    <h4><span class="warning-number">â‘ </span>ä¸œä¾¿é—¨æ¡¥</h4>
                    <p><strong>ä½ç½®ï¼š</strong>ä¸œäºŒç¯ä¸é•¿å®‰è¡—äº¤å‰å£ï¼ˆçº¦15kmå¤„ï¼‰</p>
                    <p><strong>æ­£ç¡®åšæ³•ï¼š</strong>ä»å»ºå›½é—¨å‘å—åˆ°ä¸œä¾¿é—¨ï¼Œ<span style="color:#ff6b6b;font-weight:bold;">è¿‡æ¡¥åå°½æ—©ä¸‹åˆ°æŠ¤åŸæ²³æ²³å ¤çš„ç»¿é“</span>ã€‚è·¯è¾¹æœ‰ä¸‹è¡Œå°é˜¶ï¼Œæ³¨æ„è§‚å¯Ÿã€‚</p>
                </div>

                <div class="warning-item">
                    <h4><span class="warning-number">â‘¡</span>å¹¿æ¸ é—¨æ¡¥</h4>
                    <p><strong>ä½ç½®ï¼š</strong>ä¸œå—äºŒç¯ï¼ˆçº¦17kmå¤„ï¼‰</p>
                    <p><strong>æ­£ç¡®åšæ³•ï¼š</strong>ä»ä¸œä¾¿é—¨æ²¿ç»¿é“å‘å—ï¼Œ<span style="color:#ff6b6b;font-weight:bold;">ç»§ç»­ä¿æŒåœ¨æŠ¤åŸæ²³æ²³å ¤ç»¿é“ä¸Šè·‘</span>ã€‚è¿‡å¹¿æ¸ é—¨æ¡¥åç»§ç»­æ²¿ç»¿é“å‘å—ã€‚</p>
                </div>

                <div class="warning-item">
                    <h4><span class="warning-number">â‘¢</span>æ°¸å®šé—¨åˆ°å³å®‰é—¨æ®µ</h4>
                    <p><strong>ä½ç½®ï¼š</strong>å—äºŒç¯ï¼ˆçº¦21-23kmå¤„ï¼‰</p>
                    <p><strong>æ­£ç¡®åšæ³•ï¼š</strong>è¿™æ®µæœ‰æŠ¤åŸæ²³ç»¿é“ï¼Œ<span style="color:#ff6b6b;font-weight:bold;">å°½é‡è·‘æ²³å ¤ç»¿é“</span>ï¼Œé£æ™¯å¥½ä¸”é¿å¼€è½¦æµã€‚</p>
                </div>

                <div class="warning-item">
                    <h4><span class="warning-number">â‘£</span>å¤©å®å¯ºæ¡¥ï¼ˆè¥¿äºŒç¯ï¼‰</h4>
                    <p><strong>ä½ç½®ï¼š</strong>è¥¿äºŒç¯å—æ®µï¼Œå¹¿å®‰é—¨åˆ°è¥¿ä¾¿é—¨ä¹‹é—´ï¼ˆçº¦26kmå¤„ï¼‰</p>
                    <p><strong>æ­£ç¡®åšæ³•ï¼š</strong>ä»å³å®‰é—¨ã€å¹¿å®‰é—¨å‘åŒ—ï¼Œ<span style="color:#ff6b6b;font-weight:bold;">ç»§ç»­åœ¨æŠ¤åŸæ²³ç»¿é“ä¸Šè·‘</span>ã€‚ç»¿é“åˆ°å¤©å®å¯ºæ¡¥å°±ç»“æŸäº†ï¼Œåœ¨ç»¿é“ä¸Šå®Œå…¨è¶Šè¿‡å¤©å®å¯ºæ¡¥åï¼Œç¬¬ä¸€ä¸ªä¸Šè¡Œå°é˜¶ä¸Šåˆ°é©¬è·¯ç»§ç»­å‘åŒ—ã€‚</p>
                </div>

                <div class="warning-item">
                    <h4><span class="warning-number">â‘¤</span>å¤å…´é—¨</h4>
                    <p><strong>ä½ç½®ï¼š</strong>è¥¿äºŒç¯ä¸é•¿å®‰è¡—äº¤å‰å£ï¼ˆçº¦29kmå¤„ï¼‰</p>
                    <p><strong>æ­£ç¡®åšæ³•ï¼š</strong>è¿‡å¤å…´é—¨æ—¶ï¼Œ<span style="color:#ff6b6b;font-weight:bold;">èµ°æ¡¥ä¸‹çš„è‡ªè¡Œè½¦é“</span>ï¼Œä¸è¦ä¸Šæ¡¥ã€‚ä¿æŒåœ¨å†…ç¯ï¼ˆä¸œä¾§ï¼‰è·‘ã€‚</p>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <h2>ğŸš» æ²¿é€”å…¬å•ä½ç½®ï¼ˆé‡ç‚¹æ ‡æ³¨ï¼‰</h2>
            <div class="checkpoints">
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">1. è¥¿ç›´é—¨æ¡¥åŒºå…¬å•</div>
                        <div class="toilet-address">è¥¿ç›´é—¨æ¡¥ä¸œåŒ—è§’ï¼Œè¥¿ç›´é—¨å¤–å¤§è¡—ä¸åŒ—äºŒç¯äº¤å‰å£é™„è¿‘</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">2. å¾·èƒœé—¨ç®­æ¥¼å…¬å•</div>
                        <div class="toilet-address">å¾·èƒœé—¨ç®­æ¥¼è¥¿ä¾§ï¼Œå¾·èƒœé—¨å¤–å¤§è¡—</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">3. å®‰å®šé—¨åœ°é“ç«™å…¬å•</div>
                        <div class="toilet-address">å®‰å®šé—¨åœ°é“ç«™Aå£é™„è¿‘ï¼Œå®‰å®šé—¨å¤–å¤§è¡—</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">4. ä¸œç›´é—¨æ¡¥åŒºå…¬å•</div>
                        <div class="toilet-address">ä¸œç›´é—¨æ¡¥è¥¿å—è§’ï¼Œä¸œç›´é—¨å¤–å¤§è¡—ä¸ä¸œäºŒç¯äº¤å‰å£</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">5. æœé˜³é—¨åœ°é“ç«™å…¬å•</div>
                        <div class="toilet-address">æœé˜³é—¨åœ°é“ç«™Cå£é™„è¿‘ï¼Œæœé˜³é—¨å†…å¤§è¡—</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">6. å»ºå›½é—¨æ¡¥åŒºå…¬å•</div>
                        <div class="toilet-address">å»ºå›½é—¨æ¡¥ä¸œåŒ—è§’ï¼Œå»ºå›½é—¨å¤–å¤§è¡—ä¸ä¸œäºŒç¯äº¤å‰å£</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">7. æ˜åŸå¢™é—å€å…¬å›­å…¬å•</div>
                        <div class="toilet-address">ä¸œä¾¿é—¨é™„è¿‘ï¼Œæ˜åŸå¢™é—å€å…¬å›­å†…ï¼ˆä¸œäºŒç¯ä¸å´‡æ–‡é—¨ä¸œå¤§è¡—äº¤å‰å£ï¼‰</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">8. é¾™æ½­æ¹–å…¬å›­å…¬å•</div>
                        <div class="toilet-address">å¹¿æ¸ é—¨é™„è¿‘ï¼Œé¾™æ½­æ¹–å…¬å›­åŒ—é—¨ï¼ˆå·¦å®‰é—¨å†…å¤§è¡—ï¼‰</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">9. æ°¸å®šé—¨å…¬å›­å…¬å•</div>
                        <div class="toilet-address">æ°¸å®šé—¨åŸæ¥¼é™„è¿‘ï¼Œæ°¸å®šé—¨å…¬å›­å†…</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">10. é™¶ç„¶äº­å…¬å›­å…¬å•</div>
                        <div class="toilet-address">å³å®‰é—¨é™„è¿‘ï¼Œé™¶ç„¶äº­å…¬å›­åŒ—é—¨ï¼ˆå¤ªå¹³è¡—ï¼‰</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">11. å¹¿å®‰é—¨æ¡¥åŒºå…¬å•</div>
                        <div class="toilet-address">å¹¿å®‰é—¨æ¡¥è¥¿åŒ—è§’ï¼Œå¹¿å®‰é—¨å¤–å¤§è¡—ä¸å—äºŒç¯äº¤å‰å£</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">12. å¤å…´é—¨åœ°é“ç«™å…¬å•</div>
                        <div class="toilet-address">å¤å…´é—¨åœ°é“ç«™Bå£é™„è¿‘ï¼Œå¤å…´é—¨å†…å¤§è¡—</div>
                    </div>
                </div>
                <div class="toilet-item">
                    <div class="toilet-icon">ğŸš»</div>
                    <div class="toilet-info">
                        <div class="toilet-name">13. é˜œæˆé—¨åœ°é“ç«™å…¬å•</div>
                        <div class="toilet-address">é˜œæˆé—¨åœ°é“ç«™Aå£é™„è¿‘ï¼Œé˜œæˆé—¨å†…å¤§è¡—</div>
                    </div>
                </div>
            </div>

            <div class="tips">
                <h3>ğŸ’¡ å®ç”¨è·‘æ­¥å»ºè®®ï¼ˆåŸºäºè·‘å‹ç»éªŒï¼‰</h3>
                <ul>
                    <li><strong>æœ€ä½³æ—¶é—´ï¼š</strong>æ—©ä¸Š5:30-7:00å‡ºå‘æœ€ä½³ï¼é¿å¼€è½¦æµé«˜å³°ï¼Œç©ºæ°”è´¨é‡å¥½ï¼ŒåŒ—äºŒç¯çº¢ç»¿ç¯å°‘ç­‰å¾…ã€‚å‘¨æœ«äººæµè¾ƒå¤§ï¼Œå»ºè®®å·¥ä½œæ—¥è·‘ã€‚</li>
                    <li><strong>è·¯é¢é€‰æ‹©ï¼š</strong>80%è·¯æ®µæœ‰ä¸“ä¸šç»¿é“ï¼å—äºŒç¯ã€è¥¿äºŒç¯ã€åŒ—æŠ¤åŸæ²³æœ‰å¡‘èƒ¶è·‘é“ï¼Œè½¯ç¡¬é€‚ä¸­ä¿æŠ¤è†ç›–ã€‚ä¸œäºŒç¯éƒ¨åˆ†è·¯æ®µä¸ºç¡¬è´¨æ­¥é“ã€‚</li>
                    <li><strong>ç»¿é“å…¥å£ï¼š</strong>å…³é”®ä½ç½®è¦ä¸‹åˆ°æ²³å ¤ç»¿é“ï¼šâ‘ ä¸œä¾¿é—¨æ¡¥åï¼ˆ15kmï¼‰â‘¡å¹¿æ¸ é—¨æ¡¥åï¼ˆ17kmï¼‰â‘¢å³å®‰é—¨åˆ°å¹¿å®‰é—¨æ®µï¼ˆ23-25kmï¼‰ã€‚æ³¨æ„è§‚å¯Ÿä¸‹è¡Œå°é˜¶æ ‡è¯†ã€‚</li>
                    <li><strong>è¡¥ç»™å‡†å¤‡ï¼š</strong>æºå¸¦èƒ½é‡èƒ¶2-3æ”¯ã€ç›ä¸¸ã€æ°´å£¶ï¼ˆ500mlï¼‰ã€‚å»ºè®®åœ¨12kmï¼ˆå»ºå›½é—¨ï¼‰å’Œ24kmï¼ˆå¹¿å®‰é—¨ï¼‰å¤„è¡¥å……ã€‚æ²¿é€”ä¾¿åˆ©åº—è¾ƒå¤šã€‚</li>
                    <li><strong>é…é€Ÿç­–ç•¥ï¼š</strong>å‰10kmæ§åˆ¶åœ¨5:20-5:30/kmï¼ˆç»¿é“å°‘ï¼Œçº¢ç»¿ç¯å¤šï¼‰ï¼Œä¸­æ®µ10-25kmå¯æé€Ÿè‡³5:00-5:15/kmï¼ˆç»¿é“ä¸ºä¸»ï¼‰ï¼Œæœ€å8kmæ ¹æ®ä½“åŠ›è°ƒæ•´ã€‚</li>
                    <li><strong>å®‰å…¨æ³¨æ„ï¼š</strong>æ¡¥ä¸‹é€šé“å…‰çº¿æ˜æš—ï¼ˆå°è¡—æ¡¥ã€é›å’Œå®«æ¡¥ç­‰ï¼‰ï¼Œå»ºè®®ä½©æˆ´å¤´ç¯æˆ–æ‰‹ç”µã€‚ç»¿é“ä¸Šéµå®ˆ"å·¦å¿«å³æ…¢"è§„åˆ™ï¼Œç¤¼è®©è¡Œäººã€‚</li>
                    <li><strong>å…¬å•åˆ†å¸ƒï¼š</strong>å¹³å‡æ¯2-3å…¬é‡Œæœ‰å…¬å•ï¼Œåœ°é“ç«™é™„è¿‘ã€å…¬å›­å†…éƒ½æœ‰ã€‚æ˜åŸå¢™é—å€å…¬å›­ã€é¾™æ½­å…¬å›­ã€é™¶ç„¶äº­å…¬å›­å†…è®¾æ–½å®Œå–„ã€‚</li>
                    <li><strong>æ™¯è§‚æ‰“å¡ï¼š</strong>åŒ—æŠ¤åŸæ²³è·èŠ±ï¼ˆå¤å­£ï¼‰ã€æ˜åŸå¢™é—å€ã€å¤è§‚è±¡å°ã€å·¦å®‰é—¨è§’æ¥¼ã€äºŒåå››èŠ‚æ°”å…¬å›­ï¼Œè¾¹è·‘è¾¹æ¬£èµåŒ—äº¬å†å²æ–‡åŒ–ã€‚</li>
                    <li><strong>è£…å¤‡å»ºè®®ï¼š</strong>ç©¿ç¼“å†²æ€§å¥½çš„è·‘é‹ï¼Œå¡‘èƒ¶è·‘é“å¯¹è†ç›–å‹å¥½ã€‚ç§‹å†¬å­£æ³¨æ„ä¿æš–ï¼Œå¤å­£é˜²æ™’+è¡¥æ°´ã€‚</li>
                    <li><strong>è·‘åæ¢å¤ï¼š</strong>æ²¿é€”æœ‰å¤šä¸ªåœ°é“ç«™ï¼ˆè¥¿ç›´é—¨ã€å¾·èƒœé—¨ã€ä¸œç›´é—¨ã€å»ºå›½é—¨ç­‰ï¼‰ï¼Œå¯å°±è¿‘ä¹˜åœ°é“å›å®¶ã€‚å»ºè®®æ‹‰ä¼¸15-20åˆ†é’Ÿã€‚</li>
                </ul>
            </div>
        </div>

        <div class="info-panel">
            <h2>ğŸ—ºï¸ è·¯çº¿åœ°å›¾ï¼ˆå¸¦å…¬å•æ ‡è®°ï¼‰</h2>
            
            <!-- å¤šäººä½ç½®å…±äº«é¢æ¿ -->
            <div class="share-panel">
                <div class="share-controls">
                    <input type="text" id="nicknameInput" class="nickname-input" placeholder="è¾“å…¥ä½ çš„æ˜µç§°ï¼ˆå¦‚ï¼šå°æ˜ï¼‰" maxlength="20" />
                    <button id="shareBtn" class="share-btn">ğŸŒ å¼€å§‹å…±äº«ä½ç½®</button>
                </div>
                <div id="firebaseStatus" class="firebase-status">â³ æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
                <div id="onlineUsers" class="online-users" style="display: none;">
                    <h4>ğŸ“ åœ¨çº¿ç”¨æˆ· (<span id="userCount">0</span>)</h4>
                    <div id="userList"></div>
                </div>
            </div>
            
            <div class="map-search-container">
                <input type="text" id="searchInput" class="map-search-input" placeholder="æœç´¢åœ°ç‚¹ï¼ˆå¦‚ï¼šå¤©å®‰é—¨ã€åŒ—äº¬å¤§å­¦ã€ä¸‰é‡Œå±¯ç­‰ï¼‰" />
                <button id="searchBtn" class="map-search-btn">ğŸ” æœç´¢</button>
                <button id="locationBtn" class="location-btn">ğŸ“ å®šä½</button>
            </div>
            <div id="locationInfo" class="location-info"></div>
            <div id="searchResults" class="search-result-panel"></div>
            <div id="map"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-icon" style="background: #667eea;"></div>
                    <span>è·‘æ­¥è·¯çº¿</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #28a745;"></div>
                    <span>èµ·ç‚¹/ç»ˆç‚¹ï¼ˆè¥¿ç›´é—¨ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #ffc107;"></div>
                    <span>å…¬å•ä½ç½®</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #dc3545;"></div>
                    <span>å…³é”®èŠ‚ç‚¹</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #ff6b6b;"></div>
                    <span>âš ï¸ æ˜“é”™ç‚¹ï¼ˆç‰¹åˆ«æ³¨æ„ï¼‰</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== Firebase é…ç½®å’Œåˆå§‹åŒ– ==========
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
          databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_PROJECT_ID.appspot.com",
          messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
          appId: "YOUR_APP_ID"
        };

        // åˆå§‹åŒ– Firebase
        let firebaseApp = null;
        let database = null;
        let isFirebaseEnabled = false;
        
        try {
            // æ£€æŸ¥é…ç½®æ˜¯å¦å·²æ›´æ–°
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseEnabled = true;
                console.log("âœ… Firebase åˆå§‹åŒ–æˆåŠŸ");
            } else {
                console.warn("âš ï¸ Firebase é…ç½®æœªè®¾ç½®ï¼Œå¤šäººå…±äº«åŠŸèƒ½å°†è¢«ç¦ç”¨");
            }
        } catch (error) {
            console.error("âŒ Firebase åˆå§‹åŒ–å¤±è´¥:", error);
            isFirebaseEnabled = false;
        }

        // åˆå§‹åŒ–åœ°å›¾
        var map = new BMap.Map("map");
        var point = new BMap.Point(116.349, 39.943); // è¥¿ç›´é—¨åæ ‡
        map.centerAndZoom(point, 12);
        map.enableScrollWheelZoom(true);

        // äºŒç¯è·¯çº¿å…³é”®ç‚¹åæ ‡ï¼ˆé¡ºæ—¶é’ˆï¼Œå·²æ ¹æ®çœŸå®äºŒç¯è·¯çº¿ä¿®æ­£ï¼‰
        var routePoints = [
            {name: "è¥¿ç›´é—¨", lat: 39.9434, lng: 116.3490, type: "start"},
            {name: "å¾·èƒœé—¨", lat: 39.9478, lng: 116.3745, type: "checkpoint"},
            {name: "å®‰å®šé—¨", lat: 39.9478, lng: 116.4070, type: "checkpoint"},
            {name: "ä¸œç›´é—¨", lat: 39.9380, lng: 116.4340, type: "checkpoint"},
            {name: "æœé˜³é—¨", lat: 39.9270, lng: 116.4340, type: "checkpoint"},
            {name: "å»ºå›½é—¨", lat: 39.9080, lng: 116.4340, type: "checkpoint"},
            {name: "ä¸œä¾¿é—¨", lat: 39.8950, lng: 116.4340, type: "checkpoint"},
            {name: "å¹¿æ¸ é—¨", lat: 39.8830, lng: 116.4340, type: "checkpoint"},
            {name: "å·¦å®‰é—¨", lat: 39.8700, lng: 116.4340, type: "checkpoint"},
            {name: "æ°¸å®šé—¨", lat: 39.8630, lng: 116.3950, type: "checkpoint"},
            {name: "å³å®‰é—¨", lat: 39.8630, lng: 116.3560, type: "checkpoint"},
            {name: "å¹¿å®‰é—¨", lat: 39.8830, lng: 116.3300, type: "checkpoint"},
            {name: "è¥¿ä¾¿é—¨", lat: 39.8950, lng: 116.3300, type: "checkpoint"},
            {name: "å¤å…´é—¨", lat: 39.9080, lng: 116.3300, type: "checkpoint"},
            {name: "é˜œæˆé—¨", lat: 39.9270, lng: 116.3300, type: "checkpoint"},
            {name: "è¥¿ç›´é—¨", lat: 39.9434, lng: 116.3490, type: "end"}
        ];

        // æ˜“é”™å…³é”®ç‚¹ä½ç½®
        var warningPoints = [
            {
                name: "â‘ ä¸œä¾¿é—¨æ¡¥", 
                lat: 39.895, 
                lng: 116.434, 
                warning: "ä»å»ºå›½é—¨å‘å—åˆ°ä¸œä¾¿é—¨ï¼Œè¿‡æ¡¥åå°½æ—©ä¸‹åˆ°æŠ¤åŸæ²³æ²³å ¤çš„ç»¿é“ï¼è·¯è¾¹æœ‰ä¸‹è¡Œå°é˜¶ï¼Œæ³¨æ„è§‚å¯Ÿã€‚"
            },
            {
                name: "â‘¡å¹¿æ¸ é—¨æ¡¥", 
                lat: 39.883, 
                lng: 116.434, 
                warning: "ä»ä¸œä¾¿é—¨æ²¿ç»¿é“å‘å—ï¼Œç»§ç»­ä¿æŒåœ¨æŠ¤åŸæ²³æ²³å ¤ç»¿é“ä¸Šè·‘ï¼è¿‡å¹¿æ¸ é—¨æ¡¥åç»§ç»­æ²¿ç»¿é“å‘å—ã€‚"
            },
            {
                name: "â‘¢æ°¸å®šé—¨-å³å®‰é—¨æ®µ", 
                lat: 39.863, 
                lng: 116.375, 
                warning: "è¿™æ®µæœ‰æŠ¤åŸæ²³ç»¿é“ï¼Œå°½é‡è·‘æ²³å ¤ç»¿é“ï¼Œé£æ™¯å¥½ä¸”é¿å¼€è½¦æµï¼"
            },
            {
                name: "â‘£å¤©å®å¯ºæ¡¥", 
                lat: 39.895, 
                lng: 116.330, 
                warning: "ä»å³å®‰é—¨ã€å¹¿å®‰é—¨å‘åŒ—ï¼Œç»§ç»­åœ¨æŠ¤åŸæ²³ç»¿é“ä¸Šè·‘ã€‚ç»¿é“åˆ°å¤©å®å¯ºæ¡¥ç»“æŸï¼Œå®Œå…¨è¶Šè¿‡æ¡¥åç¬¬ä¸€ä¸ªä¸Šè¡Œå°é˜¶ä¸Šé©¬è·¯ç»§ç»­å‘åŒ—ã€‚"
            },
            {
                name: "â‘¤å¤å…´é—¨", 
                lat: 39.908, 
                lng: 116.330, 
                warning: "èµ°æ¡¥ä¸‹çš„è‡ªè¡Œè½¦é“ï¼Œä¸è¦ä¸Šæ¡¥ï¼ä¿æŒåœ¨å†…ç¯ï¼ˆä¸œä¾§ï¼‰è·‘ã€‚"
            }
        ];

        // å…¬å•ä½ç½®
        var toilets = [
            {name: "è¥¿ç›´é—¨æ¡¥åŒºå…¬å•", lat: 39.943, lng: 116.350, address: "è¥¿ç›´é—¨æ¡¥ä¸œåŒ—è§’"},
            {name: "å¾·èƒœé—¨ç®­æ¥¼å…¬å•", lat: 39.948, lng: 116.373, address: "å¾·èƒœé—¨ç®­æ¥¼è¥¿ä¾§"},
            {name: "å®‰å®šé—¨åœ°é“ç«™å…¬å•", lat: 39.948, lng: 116.408, address: "å®‰å®šé—¨åœ°é“ç«™Aå£é™„è¿‘"},
            {name: "ä¸œç›´é—¨æ¡¥åŒºå…¬å•", lat: 39.938, lng: 116.433, address: "ä¸œç›´é—¨æ¡¥è¥¿å—è§’"},
            {name: "æœé˜³é—¨åœ°é“ç«™å…¬å•", lat: 39.927, lng: 116.433, address: "æœé˜³é—¨åœ°é“ç«™Cå£é™„è¿‘"},
            {name: "å»ºå›½é—¨æ¡¥åŒºå…¬å•", lat: 39.908, lng: 116.435, address: "å»ºå›½é—¨æ¡¥ä¸œåŒ—è§’"},
            {name: "æ˜åŸå¢™é—å€å…¬å›­å…¬å•", lat: 39.895, lng: 116.433, address: "æ˜åŸå¢™é—å€å…¬å›­å†…"},
            {name: "é¾™æ½­æ¹–å…¬å›­å…¬å•", lat: 39.883, lng: 116.433, address: "é¾™æ½­æ¹–å…¬å›­åŒ—é—¨"},
            {name: "æ°¸å®šé—¨å…¬å›­å…¬å•", lat: 39.863, lng: 116.395, address: "æ°¸å®šé—¨å…¬å›­å†…"},
            {name: "é™¶ç„¶äº­å…¬å›­å…¬å•", lat: 39.863, lng: 116.357, address: "é™¶ç„¶äº­å…¬å›­åŒ—é—¨"},
            {name: "å¹¿å®‰é—¨æ¡¥åŒºå…¬å•", lat: 39.883, lng: 116.331, address: "å¹¿å®‰é—¨æ¡¥è¥¿åŒ—è§’"},
            {name: "å¤å…´é—¨åœ°é“ç«™å…¬å•", lat: 39.908, lng: 116.331, address: "å¤å…´é—¨åœ°é“ç«™Bå£é™„è¿‘"},
            {name: "é˜œæˆé—¨åœ°é“ç«™å…¬å•", lat: 39.927, lng: 116.331, address: "é˜œæˆé—¨åœ°é“ç«™Aå£é™„è¿‘"}
        ];

        // ç»˜åˆ¶è·¯çº¿
        var polylinePoints = [];
        routePoints.forEach(function(point) {
            polylinePoints.push(new BMap.Point(point.lng, point.lat));
        });

        var polyline = new BMap.Polyline(polylinePoints, {
            strokeColor: "#667eea",
            strokeWeight: 4,
            strokeOpacity: 0.8
        });
        map.addOverlay(polyline);

        // æ·»åŠ å…³é”®èŠ‚ç‚¹æ ‡è®°
        routePoints.forEach(function(point, index) {
            var pt = new BMap.Point(point.lng, point.lat);
            var icon, label;
            
            if (point.type === "start" || point.type === "end") {
                icon = new BMap.Icon("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='40'%3E%3Cpath d='M15,0 C6.7,0 0,6.7 0,15 C0,26.2 15,40 15,40 S30,26.2 30,15 C30,6.7 23.3,0 15,0 Z' fill='%2328a745'/%3E%3Ccircle cx='15' cy='15' r='8' fill='white'/%3E%3C/svg%3E", new BMap.Size(30, 40));
                label = new BMap.Label(point.name, {offset: new BMap.Size(0, -45)});
                label.setStyle({
                    color: "#28a745",
                    fontSize: "14px",
                    fontWeight: "bold",
                    border: "none",
                    backgroundColor: "white",
                    padding: "5px 10px",
                    borderRadius: "4px",
                    boxShadow: "0 2px 6px rgba(0,0,0,0.2)"
                });
            } else {
                icon = new BMap.Icon("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='32'%3E%3Cpath d='M12,0 C5.4,0 0,5.4 0,12 C0,21 12,32 12,32 S24,21 24,12 C24,5.4 18.6,0 12,0 Z' fill='%23dc3545'/%3E%3Ccircle cx='12' cy='12' r='6' fill='white'/%3E%3C/svg%3E", new BMap.Size(24, 32));
                label = new BMap.Label(point.name, {offset: new BMap.Size(0, -38)});
                label.setStyle({
                    color: "#dc3545",
                    fontSize: "12px",
                    border: "none",
                    backgroundColor: "white",
                    padding: "3px 8px",
                    borderRadius: "3px",
                    boxShadow: "0 1px 4px rgba(0,0,0,0.2)"
                });
            }
            
            var marker = new BMap.Marker(pt, {icon: icon});
            marker.setLabel(label);
            map.addOverlay(marker);
        });

        // æ·»åŠ æ˜“é”™ç‚¹æ ‡è®°ï¼ˆç‰¹åˆ«é†’ç›®ï¼‰
        warningPoints.forEach(function(point) {
            var pt = new BMap.Point(point.lng, point.lat);
            var icon = new BMap.Icon("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='42'%3E%3Cpath d='M16,0 C7.2,0 0,7.2 0,16 C0,28 16,42 16,42 S32,28 32,16 C32,7.2 24.8,0 16,0 Z' fill='%23ff6b6b'/%3E%3Ctext x='16' y='20' text-anchor='middle' font-size='18' font-weight='bold' fill='white'%3Eâš %3C/text%3E%3C/svg%3E", new BMap.Size(32, 42));
            
            var marker = new BMap.Marker(pt, {icon: icon});
            
            var label = new BMap.Label(point.name, {offset: new BMap.Size(0, -48)});
            label.setStyle({
                color: "#ff6b6b",
                fontSize: "13px",
                fontWeight: "bold",
                border: "2px solid #ff6b6b",
                backgroundColor: "white",
                padding: "4px 10px",
                borderRadius: "4px",
                boxShadow: "0 2px 8px rgba(255,107,107,0.4)"
            });
            marker.setLabel(label);
            
            var infoWindow = new BMap.InfoWindow(
                "<div style='padding:12px;max-width:300px;'>" +
                "<h4 style='margin:0 0 10px 0;color:#ff6b6b;font-size:15px;'>" + point.name + " - æ˜“é”™ç‚¹</h4>" +
                "<p style='margin:0;color:#333;font-size:14px;line-height:1.6;'><strong>âš ï¸ æ³¨æ„ï¼š</strong>" + point.warning + "</p>" +
                "</div>",
                {width: 320}
            );
            
            marker.addEventListener("click", function() {
                this.openInfoWindow(infoWindow);
            });
            
            // æ·»åŠ é—ªçƒåŠ¨ç”»æ•ˆæœ
            marker.setAnimation(BMAP_ANIMATION_BOUNCE);
            setTimeout(function() {
                marker.setAnimation(null);
            }, 3000);
            
            map.addOverlay(marker);
        });

        // æ·»åŠ å…¬å•æ ‡è®°
        toilets.forEach(function(toilet) {
            var pt = new BMap.Point(toilet.lng, toilet.lat);
            var icon = new BMap.Icon("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='32'%3E%3Cpath d='M12,0 C5.4,0 0,5.4 0,12 C0,21 12,32 12,32 S24,21 24,12 C24,5.4 18.6,0 12,0 Z' fill='%23ffc107'/%3E%3Ctext x='12' y='16' text-anchor='middle' font-size='14' fill='white'%3EğŸš»%3C/text%3E%3C/svg%3E", new BMap.Size(24, 32));
            
            var marker = new BMap.Marker(pt, {icon: icon});
            
            var infoWindow = new BMap.InfoWindow(
                "<div style='padding:10px;'>" +
                "<h4 style='margin:0 0 8px 0;color:#333;'>" + toilet.name + "</h4>" +
                "<p style='margin:0;color:#666;font-size:13px;'>" + toilet.address + "</p>" +
                "</div>",
                {width: 250}
            );
            
            marker.addEventListener("click", function() {
                this.openInfoWindow(infoWindow);
            });
            
            map.addOverlay(marker);
        });

        // æ·»åŠ è·ç¦»æ ‡å°º
        var distanceControl = new BMap.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});
        map.addControl(distanceControl);

        // æ·»åŠ ç¼©æ”¾æ§ä»¶
        var navigationControl = new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_RIGHT});
        map.addControl(navigationControl);

        // ========== åœ°ç‚¹æœç´¢åŠŸèƒ½ ==========
        var searchMarker = null; // ä¿å­˜æœç´¢ç»“æœçš„æ ‡è®°
        var localSearch = new BMap.LocalSearch(map, {
            onSearchComplete: function(results) {
                var resultsPanel = document.getElementById('searchResults');
                resultsPanel.innerHTML = '';
                
                if (localSearch.getStatus() == BMAP_STATUS_SUCCESS) {
                    var resultsHtml = '';
                    var resultsCount = Math.min(results.getCurrentNumPois(), 5); // æœ€å¤šæ˜¾ç¤º5ä¸ªç»“æœ
                    
                    for (var i = 0; i < resultsCount; i++) {
                        var poi = results.getPoi(i);
                        resultsHtml += '<div class="search-result-item" data-index="' + i + '">' +
                            '<div class="search-result-title">' + poi.title + '</div>' +
                            '<div class="search-result-address">' + poi.address + '</div>' +
                            '</div>';
                    }
                    
                    resultsPanel.innerHTML = resultsHtml;
                    resultsPanel.style.display = 'block';
                    
                    // ä¸ºæ¯ä¸ªæœç´¢ç»“æœæ·»åŠ ç‚¹å‡»äº‹ä»¶
                    var resultItems = resultsPanel.getElementsByClassName('search-result-item');
                    for (var i = 0; i < resultItems.length; i++) {
                        resultItems[i].addEventListener('click', function() {
                            var index = parseInt(this.getAttribute('data-index'));
                            var poi = results.getPoi(index);
                            showSearchResult(poi);
                            resultsPanel.style.display = 'none';
                        });
                    }
                } else {
                    resultsPanel.innerHTML = '<div class="search-result-item">æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</div>';
                    resultsPanel.style.display = 'block';
                }
            }
        });

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function showSearchResult(poi) {
            // ç§»é™¤ä¹‹å‰çš„æœç´¢æ ‡è®°
            if (searchMarker) {
                map.removeOverlay(searchMarker);
            }
            
            // åˆ›å»ºæ–°çš„æœç´¢æ ‡è®°
            var point = poi.point;
            var icon = new BMap.Icon(
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='42'%3E%3Cpath d='M16,0 C7.2,0 0,7.2 0,16 C0,28 16,42 16,42 S32,28 32,16 C32,7.2 24.8,0 16,0 Z' fill='%2300bcd4'/%3E%3Ccircle cx='16' cy='16' r='8' fill='white'/%3E%3C/svg%3E",
                new BMap.Size(32, 42)
            );
            
            searchMarker = new BMap.Marker(point, {icon: icon});
            map.addOverlay(searchMarker);
            
            // åˆ›å»ºä¿¡æ¯çª—å£
            var infoWindow = new BMap.InfoWindow(
                "<div style='padding:12px;max-width:300px;'>" +
                "<h4 style='margin:0 0 10px 0;color:#00bcd4;font-size:16px;'>" + poi.title + "</h4>" +
                "<p style='margin:0 0 8px 0;color:#666;font-size:14px;'><strong>åœ°å€ï¼š</strong>" + poi.address + "</p>" +
                (poi.phoneNumber ? "<p style='margin:0;color:#666;font-size:14px;'><strong>ç”µè¯ï¼š</strong>" + poi.phoneNumber + "</p>" : "") +
                "</div>",
                {width: 320}
            );
            
            searchMarker.openInfoWindow(infoWindow);
            
            // ç§»åŠ¨åœ°å›¾ä¸­å¿ƒåˆ°æœç´¢ç»“æœï¼Œå¹¶è°ƒæ•´ç¼©æ”¾çº§åˆ«
            map.centerAndZoom(point, 15);
            
            // æ·»åŠ åŠ¨ç”»æ•ˆæœ
            searchMarker.setAnimation(BMAP_ANIMATION_BOUNCE);
            setTimeout(function() {
                searchMarker.setAnimation(null);
            }, 2000);
        }

        // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('searchBtn').addEventListener('click', function() {
            var keyword = document.getElementById('searchInput').value.trim();
            if (keyword) {
                localSearch.search(keyword);
            } else {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
            }
        });

        // æœç´¢æ¡†å›è½¦äº‹ä»¶
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        // ç‚¹å‡»åœ°å›¾å…¶ä»–åœ°æ–¹éšè—æœç´¢ç»“æœé¢æ¿
        map.addEventListener('click', function() {
            document.getElementById('searchResults').style.display = 'none';
        });

        // ç‚¹å‡»æœç´¢ç»“æœé¢æ¿å¤–éƒ¨éšè—é¢æ¿
        document.addEventListener('click', function(e) {
            var resultsPanel = document.getElementById('searchResults');
            var searchContainer = document.querySelector('.map-search-container');
            if (!resultsPanel.contains(e.target) && !searchContainer.contains(e.target)) {
                resultsPanel.style.display = 'none';
            }
        });

        // ========== å¤šäººä½ç½®å…±äº«åŠŸèƒ½ ==========
        var isSharing = false; // æ˜¯å¦æ­£åœ¨å…±äº«ä½ç½®
        var myUserId = null; // å½“å‰ç”¨æˆ·ID
        var myNickname = null; // å½“å‰ç”¨æˆ·æ˜µç§°
        var otherUsersMarkers = {}; // å…¶ä»–ç”¨æˆ·çš„æ ‡è®° {userId: {marker, circle, label}}
        var userColors = {}; // ç”¨æˆ·é¢œè‰²æ˜ å°„
        var availableColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788'
        ];
        var colorIndex = 0;

        // ç”Ÿæˆå”¯ä¸€ç”¨æˆ·ID
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // è·å–ç”¨æˆ·é¢œè‰²
        function getUserColor(userId) {
            if (!userColors[userId]) {
                userColors[userId] = availableColors[colorIndex % availableColors.length];
                colorIndex++;
            }
            return userColors[userId];
        }

        // åˆ›å»ºå…¶ä»–ç”¨æˆ·çš„å®šä½å›¾æ ‡
        function createOtherUserIcon(color, heading) {
            if (heading !== null && heading !== undefined && !isNaN(heading)) {
                return new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36'%3E%3Ccircle cx='18' cy='18' r='16' fill='" + encodeURIComponent(color) + "' opacity='0.3'/%3E%3Ccircle cx='18' cy='18' r='10' fill='" + encodeURIComponent(color) + "'/%3E%3Ccircle cx='18' cy='18' r='5' fill='white'/%3E%3Cpath d='M 18 6 L 22 14 L 18 12 L 14 14 Z' fill='white' transform='rotate(" + heading + " 18 18)'/%3E%3C/svg%3E",
                    new BMap.Size(36, 36),
                    {anchor: new BMap.Size(18, 18)}
                );
            } else {
                return new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36'%3E%3Ccircle cx='18' cy='18' r='16' fill='" + encodeURIComponent(color) + "' opacity='0.3'/%3E%3Ccircle cx='18' cy='18' r='10' fill='" + encodeURIComponent(color) + "'/%3E%3Ccircle cx='18' cy='18' r='5' fill='white'/%3E%3C/svg%3E",
                    new BMap.Size(36, 36),
                    {anchor: new BMap.Size(18, 18)}
                );
            }
        }

        // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        function updateOnlineUsersList(users) {
            var userList = document.getElementById('userList');
            var userCount = document.getElementById('userCount');
            var onlineUsersDiv = document.getElementById('onlineUsers');
            
            var count = 0;
            var html = '';
            
            for (var userId in users) {
                if (userId === myUserId) continue; // è·³è¿‡è‡ªå·±
                
                var user = users[userId];
                var color = getUserColor(userId);
                count++;
                
                // è®¡ç®—è·ç¦»
                var distance = '';
                if (lastPosition && user.lat && user.lng) {
                    var userPoint = new BMap.Point(user.lng, user.lat);
                    var myPoint = new BMap.Point(lastPosition.lng, lastPosition.lat);
                    var dist = map.getDistance(userPoint, myPoint);
                    if (dist < 1000) {
                        distance = Math.round(dist) + 'm';
                    } else {
                        distance = (dist / 1000).toFixed(1) + 'km';
                    }
                }
                
                html += '<div class="user-item">' +
                    '<div class="user-color" style="background: ' + color + ';"></div>' +
                    '<div class="user-name">' + (user.nickname || 'åŒ¿åç”¨æˆ·') + '</div>' +
                    (distance ? '<div class="user-distance">' + distance + '</div>' : '') +
                    '</div>';
            }
            
            userCount.textContent = count;
            userList.innerHTML = html || '<div style="text-align:center;color:#999;padding:10px;">æš‚æ— å…¶ä»–ç”¨æˆ·åœ¨çº¿</div>';
            onlineUsersDiv.style.display = isSharing ? 'block' : 'none';
        }

        // æ›´æ–°å…¶ä»–ç”¨æˆ·çš„åœ°å›¾æ ‡è®°
        function updateOtherUserMarker(userId, userData) {
            if (userId === myUserId) return; // ä¸æ˜¾ç¤ºè‡ªå·±
            
            var point = new BMap.Point(userData.lng, userData.lat);
            var color = getUserColor(userId);
            
            // ç§»é™¤æ—§æ ‡è®°
            if (otherUsersMarkers[userId]) {
                if (otherUsersMarkers[userId].marker) {
                    map.removeOverlay(otherUsersMarkers[userId].marker);
                }
                if (otherUsersMarkers[userId].circle) {
                    map.removeOverlay(otherUsersMarkers[userId].circle);
                }
                if (otherUsersMarkers[userId].label) {
                    map.removeOverlay(otherUsersMarkers[userId].label);
                }
            }
            
            // åˆ›å»ºæ–°æ ‡è®°
            var icon = createOtherUserIcon(color, userData.heading);
            var marker = new BMap.Marker(point, {icon: icon});
            
            // åˆ›å»ºç²¾åº¦åœˆ
            var circle = new BMap.Circle(point, userData.accuracy || 50, {
                strokeColor: color,
                strokeWeight: 1,
                strokeOpacity: 0.3,
                fillColor: color,
                fillOpacity: 0.1
            });
            
            // åˆ›å»ºæ ‡ç­¾
            var label = new BMap.Label(userData.nickname || 'åŒ¿å', {
                offset: new BMap.Size(0, -40)
            });
            label.setStyle({
                color: color,
                fontSize: '12px',
                fontWeight: 'bold',
                border: 'none',
                backgroundColor: 'white',
                padding: '3px 8px',
                borderRadius: '3px',
                boxShadow: '0 1px 4px rgba(0,0,0,0.2)'
            });
            
            marker.setLabel(label);
            
            // æ·»åŠ ä¿¡æ¯çª—å£
            var speedKmh = userData.speed ? (userData.speed * 3.6).toFixed(1) : '0.0';
            var infoWindow = new BMap.InfoWindow(
                "<div style='padding:10px;'>" +
                "<h4 style='margin:0 0 8px 0;color:" + color + ";'>ğŸ‘¤ " + (userData.nickname || 'åŒ¿åç”¨æˆ·') + "</h4>" +
                "<p style='margin:0;font-size:13px;color:#666;'>é€Ÿåº¦ï¼š" + speedKmh + " km/h</p>" +
                (userData.heading ? "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>æ–¹å‘ï¼š" + Math.round(userData.heading) + "Â°</p>" : "") +
                "<p style='margin:4px 0 0 0;font-size:13px;color:#999;'>æ›´æ–°ï¼š" + new Date(userData.timestamp).toLocaleTimeString() + "</p>" +
                "</div>",
                {width: 200}
            );
            
            marker.addEventListener('click', function() {
                this.openInfoWindow(infoWindow);
            });
            
            map.addOverlay(marker);
            map.addOverlay(circle);
            
            otherUsersMarkers[userId] = {marker: marker, circle: circle, label: label};
        }

        // ç§»é™¤ç”¨æˆ·æ ‡è®°
        function removeUserMarker(userId) {
            if (otherUsersMarkers[userId]) {
                if (otherUsersMarkers[userId].marker) {
                    map.removeOverlay(otherUsersMarkers[userId].marker);
                }
                if (otherUsersMarkers[userId].circle) {
                    map.removeOverlay(otherUsersMarkers[userId].circle);
                }
                delete otherUsersMarkers[userId];
            }
        }

        // å¼€å§‹å…±äº«ä½ç½®
        function startSharing() {
            if (!isFirebaseEnabled) {
                alert('âŒ Firebase æœªé…ç½®ï¼Œæ— æ³•ä½¿ç”¨å¤šäººå…±äº«åŠŸèƒ½ã€‚\n\nè¯·æŒ‰ç…§ FIREBASE_SETUP.md ä¸­çš„è¯´æ˜é…ç½® Firebaseã€‚');
                return;
            }
            
            var nickname = document.getElementById('nicknameInput').value.trim();
            if (!nickname) {
                alert('è¯·è¾“å…¥ä½ çš„æ˜µç§°');
                document.getElementById('nicknameInput').focus();
                return;
            }
            
            myUserId = generateUserId();
            myNickname = nickname;
            isSharing = true;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            var shareBtn = document.getElementById('shareBtn');
            shareBtn.textContent = 'ğŸ”´ åœæ­¢å…±äº«';
            shareBtn.classList.add('active');
            document.getElementById('nicknameInput').disabled = true;
            
            // ç›‘å¬å…¶ä»–ç”¨æˆ·
            database.ref('users').on('value', function(snapshot) {
                var users = snapshot.val() || {};
                updateOnlineUsersList(users);
                
                // æ›´æ–°åœ°å›¾æ ‡è®°
                for (var userId in users) {
                    updateOtherUserMarker(userId, users[userId]);
                }
                
                // ç§»é™¤å·²ç¦»çº¿ç”¨æˆ·çš„æ ‡è®°
                for (var userId in otherUsersMarkers) {
                    if (!users[userId]) {
                        removeUserMarker(userId);
                    }
                }
            });
            
            // ç›‘å¬ç”¨æˆ·ç¦»çº¿
            database.ref('users/' + myUserId).onDisconnect().remove();
            
            // å¼€å§‹å®šä½
            if (!isTracking) {
                document.getElementById('locationBtn').click();
            }
        }

        // åœæ­¢å…±äº«ä½ç½®
        function stopSharing() {
            if (!isFirebaseEnabled || !myUserId) return;
            
            isSharing = false;
            
            // ä»æ•°æ®åº“ç§»é™¤è‡ªå·±
            database.ref('users/' + myUserId).remove();
            database.ref('users').off();
            
            // æ¸…é™¤æ‰€æœ‰å…¶ä»–ç”¨æˆ·æ ‡è®°
            for (var userId in otherUsersMarkers) {
                removeUserMarker(userId);
            }
            otherUsersMarkers = {};
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            var shareBtn = document.getElementById('shareBtn');
            shareBtn.textContent = 'ğŸŒ å¼€å§‹å…±äº«ä½ç½®';
            shareBtn.classList.remove('active');
            document.getElementById('nicknameInput').disabled = false;
            document.getElementById('onlineUsers').style.display = 'none';
            
            myUserId = null;
            myNickname = null;
        }

        // æ›´æ–°è‡ªå·±çš„ä½ç½®åˆ° Firebase
        function updateMyLocationToFirebase(lat, lng, accuracy, speed, heading) {
            if (!isSharing || !myUserId || !isFirebaseEnabled) return;
            
            database.ref('users/' + myUserId).set({
                nickname: myNickname,
                lat: lat,
                lng: lng,
                accuracy: accuracy,
                speed: speed || 0,
                heading: heading || 0,
                timestamp: Date.now()
            });
        }

        // Firebase è¿æ¥çŠ¶æ€ç›‘å¬
        if (isFirebaseEnabled) {
            database.ref('.info/connected').on('value', function(snapshot) {
                var statusDiv = document.getElementById('firebaseStatus');
                if (snapshot.val() === true) {
                    statusDiv.textContent = 'âœ… æœåŠ¡å™¨å·²è¿æ¥';
                    statusDiv.className = 'firebase-status connected';
                } else {
                    statusDiv.textContent = 'âŒ æœåŠ¡å™¨è¿æ¥æ–­å¼€';
                    statusDiv.className = 'firebase-status error';
                }
            });
        } else {
            var statusDiv = document.getElementById('firebaseStatus');
            statusDiv.textContent = 'âš ï¸ Firebase æœªé…ç½®ï¼Œè¯·æŸ¥çœ‹ FIREBASE_SETUP.md';
            statusDiv.className = 'firebase-status error';
        }

        // å…±äº«æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('shareBtn').addEventListener('click', function() {
            if (isSharing) {
                stopSharing();
            } else {
                startSharing();
            }
        });

        // ========== å®æ—¶å®šä½åŠŸèƒ½ ==========
        var locationMarker = null; // å½“å‰ä½ç½®æ ‡è®°
        var locationCircle = null; // ä½ç½®ç²¾åº¦åœˆ
        var directionArrow = null; // æ–¹å‘ç®­å¤´
        var watchId = null; // å®šä½ç›‘å¬ID
        var isTracking = false; // æ˜¯å¦æ­£åœ¨è¿½è¸ª
        var lastPosition = null; // ä¸Šä¸€æ¬¡çš„ä½ç½®
        var currentHeading = 0; // å½“å‰æ–¹å‘è§’åº¦

        // åˆ›å»ºè‡ªå®šä¹‰å®šä½å›¾æ ‡ï¼ˆå¸¦æ–¹å‘ç®­å¤´ï¼‰
        function createLocationIcon(heading) {
            // å¦‚æœæœ‰æ–¹å‘ä¿¡æ¯ï¼Œåˆ›å»ºå¸¦ç®­å¤´çš„å›¾æ ‡
            if (heading !== null && heading !== undefined && !isNaN(heading)) {
                return new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%234285f4;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%231a73e8;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='20' cy='20' r='18' fill='%234285f4' opacity='0.2'/%3E%3Ccircle cx='20' cy='20' r='12' fill='url(%23grad)'/%3E%3Ccircle cx='20' cy='20' r='6' fill='white'/%3E%3Cpath d='M 20 8 L 24 16 L 20 14 L 16 16 Z' fill='white' transform='rotate(" + heading + " 20 20)'/%3E%3C/svg%3E",
                    new BMap.Size(40, 40),
                    {anchor: new BMap.Size(20, 20)}
                );
            } else {
                // æ²¡æœ‰æ–¹å‘ä¿¡æ¯ï¼Œä½¿ç”¨æ™®é€šåœ†ç‚¹
                return new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%234285f4;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%231a73e8;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='20' cy='20' r='18' fill='%234285f4' opacity='0.2'/%3E%3Ccircle cx='20' cy='20' r='12' fill='url(%23grad)'/%3E%3Ccircle cx='20' cy='20' r='6' fill='white'/%3E%3C/svg%3E",
                    new BMap.Size(40, 40),
                    {anchor: new BMap.Size(20, 20)}
                );
            }
        }

        // è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„æ–¹å‘è§’åº¦ï¼ˆè¿”å›0-360åº¦ï¼Œ0åº¦ä¸ºæ­£åŒ—ï¼‰
        function calculateHeading(lat1, lng1, lat2, lng2) {
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var lat1Rad = lat1 * Math.PI / 180;
            var lat2Rad = lat2 * Math.PI / 180;
            
            var y = Math.sin(dLng) * Math.cos(lat2Rad);
            var x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                    Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
            
            var heading = Math.atan2(y, x) * 180 / Math.PI;
            return (heading + 360) % 360; // è½¬æ¢ä¸º0-360åº¦
        }

        // è®¡ç®—åˆ°æœ€è¿‘è·¯çº¿ç‚¹çš„è·ç¦»
        function calculateDistanceToRoute(lat, lng) {
            var userPoint = new BMap.Point(lng, lat);
            var minDistance = Infinity;
            var nearestPoint = null;

            routePoints.forEach(function(point) {
                var routePoint = new BMap.Point(point.lng, point.lat);
                var distance = map.getDistance(userPoint, routePoint);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestPoint = point;
                }
            });

            return {
                distance: Math.round(minDistance),
                nearestPoint: nearestPoint
            };
        }

        // æ›´æ–°ä½ç½®ä¿¡æ¯æ˜¾ç¤º
        function updateLocationInfo(position, accuracy, routeInfo, speed, heading) {
            var infoPanel = document.getElementById('locationInfo');
            var distanceText = routeInfo.distance < 1000 
                ? routeInfo.distance + 'ç±³' 
                : (routeInfo.distance / 1000).toFixed(2) + 'å…¬é‡Œ';
            
            var statusEmoji = routeInfo.distance < 100 ? 'âœ…' : routeInfo.distance < 500 ? 'âš ï¸' : 'âŒ';
            var statusText = routeInfo.distance < 100 
                ? 'åœ¨è·¯çº¿ä¸Š' 
                : routeInfo.distance < 500 
                ? 'æ¥è¿‘è·¯çº¿' 
                : 'åç¦»è·¯çº¿';

            // è®¡ç®—é…é€Ÿï¼ˆåˆ†é’Ÿ/å…¬é‡Œï¼‰
            var paceText = '';
            if (speed && speed > 0.5) { // é€Ÿåº¦å¤§äº0.5 m/s (1.8 km/h) æ‰æ˜¾ç¤ºé…é€Ÿ
                var kmPerHour = speed * 3.6; // è½¬æ¢ä¸ºå…¬é‡Œ/å°æ—¶
                var minPerKm = 60 / kmPerHour; // åˆ†é’Ÿ/å…¬é‡Œ
                var paceMin = Math.floor(minPerKm);
                var paceSec = Math.round((minPerKm - paceMin) * 60);
                paceText = '<br>ğŸƒ é…é€Ÿï¼š' + paceMin + '\'' + (paceSec < 10 ? '0' : '') + paceSec + '"/km';
            }

            // æ–¹å‘æ–‡å­—
            var directionText = '';
            if (heading !== null && heading !== undefined && !isNaN(heading)) {
                var directions = ['åŒ—', 'ä¸œåŒ—', 'ä¸œ', 'ä¸œå—', 'å—', 'è¥¿å—', 'è¥¿', 'è¥¿åŒ—'];
                var index = Math.round(heading / 45) % 8;
                directionText = '<br>ğŸ§­ æ–¹å‘ï¼š' + directions[index] + ' (' + Math.round(heading) + 'Â°)';
            }

            infoPanel.innerHTML = 
                '<strong>' + statusEmoji + ' ' + statusText + '</strong><br>' +
                'ğŸ“ æœ€è¿‘èŠ‚ç‚¹ï¼š' + routeInfo.nearestPoint.name + '<br>' +
                'ğŸ“ è·ç¦»è·¯çº¿ï¼š' + distanceText +
                paceText +
                directionText +
                '<br><span class="location-accuracy">å®šä½ç²¾åº¦ï¼šÂ±' + Math.round(accuracy) + 'ç±³</span>';
            infoPanel.classList.add('show');
        }

        // å®šä½æˆåŠŸå›è°ƒ
        function onLocationSuccess(position) {
            var lat = position.coords.latitude;
            var lng = position.coords.longitude;
            var accuracy = position.coords.accuracy;
            var speed = position.coords.speed; // é€Ÿåº¦ï¼ˆç±³/ç§’ï¼‰
            var heading = position.coords.heading; // è®¾å¤‡æŒ‡å—é’ˆæ–¹å‘

            var point = new BMap.Point(lng, lat);

            // è®¡ç®—ç§»åŠ¨æ–¹å‘ï¼ˆå¦‚æœæœ‰ä¸Šä¸€æ¬¡ä½ç½®ï¼‰
            if (lastPosition && speed && speed > 0.5) { // é€Ÿåº¦å¤§äº0.5m/sæ‰è®¡ç®—æ–¹å‘
                var calculatedHeading = calculateHeading(
                    lastPosition.lat, 
                    lastPosition.lng, 
                    lat, 
                    lng
                );
                // ä¼˜å…ˆä½¿ç”¨è®¡ç®—å‡ºçš„æ–¹å‘ï¼Œå¦‚æœè®¾å¤‡æ²¡æœ‰æä¾›heading
                currentHeading = heading !== null && heading !== undefined && !isNaN(heading) 
                    ? heading 
                    : calculatedHeading;
            } else if (heading !== null && heading !== undefined && !isNaN(heading)) {
                currentHeading = heading;
            }

            // ä¿å­˜å½“å‰ä½ç½®ä¾›ä¸‹æ¬¡ä½¿ç”¨
            lastPosition = {lat: lat, lng: lng};

            // ç§»é™¤æ—§æ ‡è®°
            if (locationMarker) {
                map.removeOverlay(locationMarker);
            }
            if (locationCircle) {
                map.removeOverlay(locationCircle);
            }

            // åˆ›å»ºæ–°çš„ä½ç½®æ ‡è®°ï¼ˆå¸¦æ–¹å‘ï¼‰
            var icon = createLocationIcon(currentHeading);
            locationMarker = new BMap.Marker(point, {icon: icon});
            map.addOverlay(locationMarker);

            // åˆ›å»ºç²¾åº¦åœˆ
            locationCircle = new BMap.Circle(point, accuracy, {
                strokeColor: '#4285f4',
                strokeWeight: 1,
                strokeOpacity: 0.3,
                fillColor: '#4285f4',
                fillOpacity: 0.1
            });
            map.addOverlay(locationCircle);

            // è®¡ç®—åˆ°è·¯çº¿çš„è·ç¦»
            var routeInfo = calculateDistanceToRoute(lat, lng);

            // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
            updateLocationInfo(position, accuracy, routeInfo, speed, currentHeading);

            // åŒæ­¥ä½ç½®åˆ° Firebaseï¼ˆå¦‚æœæ­£åœ¨å…±äº«ï¼‰
            updateMyLocationToFirebase(lat, lng, accuracy, speed, currentHeading);

            // ç§»åŠ¨æ—¶åœ°å›¾è·Ÿéšï¼ˆå¹³æ»‘ç§»åŠ¨ï¼‰
            if (isTracking) {
                map.panTo(point);
            } else {
                // é¦–æ¬¡å®šä½æ—¶ç§»åŠ¨åœ°å›¾ä¸­å¿ƒ
                map.centerAndZoom(point, 16);
            }

            // æ·»åŠ ä¿¡æ¯çª—å£
            var speedKmh = speed ? (speed * 3.6).toFixed(1) : '0.0';
            var infoWindow = new BMap.InfoWindow(
                "<div style='padding:10px;'>" +
                "<h4 style='margin:0 0 8px 0;color:#4285f4;'>ğŸ“ å½“å‰ä½ç½®</h4>" +
                "<p style='margin:0;font-size:13px;color:#666;'>çº¬åº¦ï¼š" + lat.toFixed(6) + "</p>" +
                "<p style='margin:0;font-size:13px;color:#666;'>ç»åº¦ï¼š" + lng.toFixed(6) + "</p>" +
                "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>ç²¾åº¦ï¼šÂ±" + Math.round(accuracy) + "ç±³</p>" +
                "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>é€Ÿåº¦ï¼š" + speedKmh + " km/h</p>" +
                (currentHeading ? "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>æ–¹å‘ï¼š" + Math.round(currentHeading) + "Â°</p>" : "") +
                "</div>",
                {width: 250}
            );

            locationMarker.addEventListener('click', function() {
                this.openInfoWindow(infoWindow);
            });
        }

        // å®šä½å¤±è´¥å›è°ƒ
        function onLocationError(error) {
            var errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šç”¨æˆ·æ‹’ç»äº†å®šä½è¯·æ±‚';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šè¯·æ±‚è¶…æ—¶';
                    break;
                default:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šæœªçŸ¥é”™è¯¯';
            }
            
            var infoPanel = document.getElementById('locationInfo');
            infoPanel.innerHTML = '<strong>' + errorMsg + '</strong><br>' +
                '<span class="location-accuracy">è¯·ç¡®ä¿å·²å…è®¸æµè§ˆå™¨è®¿é—®ä½ç½®ä¿¡æ¯</span>';
            infoPanel.classList.add('show');

            // åœæ­¢è¿½è¸ª
            stopTracking();
        }

        // å¼€å§‹è¿½è¸ª
        function startTracking() {
            if (!navigator.geolocation) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½');
                return;
            }

            isTracking = true;
            var locationBtn = document.getElementById('locationBtn');
            locationBtn.classList.add('active');
            locationBtn.innerHTML = 'ğŸ”´ åœæ­¢å®šä½';

            // ä½¿ç”¨ watchPosition å®ç°å®æ—¶è¿½è¸ª
            watchId = navigator.geolocation.watchPosition(
                onLocationSuccess,
                onLocationError,
                {
                    enableHighAccuracy: true, // é«˜ç²¾åº¦æ¨¡å¼
                    timeout: 10000, // 10ç§’è¶…æ—¶
                    maximumAge: 0 // ä¸ä½¿ç”¨ç¼“å­˜ä½ç½®
                }
            );
        }

        // åœæ­¢è¿½è¸ª
        function stopTracking() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            isTracking = false;
            lastPosition = null; // é‡ç½®ä¸Šæ¬¡ä½ç½®
            currentHeading = 0; // é‡ç½®æ–¹å‘
            
            var locationBtn = document.getElementById('locationBtn');
            locationBtn.classList.remove('active');
            locationBtn.innerHTML = 'ğŸ“ å®šä½';

            // ç§»é™¤ä½ç½®æ ‡è®°
            if (locationMarker) {
                map.removeOverlay(locationMarker);
                locationMarker = null;
            }
            if (locationCircle) {
                map.removeOverlay(locationCircle);
                locationCircle = null;
            }

            // éšè—ä¿¡æ¯é¢æ¿
            var infoPanel = document.getElementById('locationInfo');
            infoPanel.classList.remove('show');
        }

        // å®šä½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('locationBtn').addEventListener('click', function() {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        });

        // é¡µé¢å¸è½½æ—¶åœæ­¢è¿½è¸ª
        window.addEventListener('beforeunload', function() {
            if (isTracking) {
                stopTracking();
            }
        });
    </script>
</body>
</html>