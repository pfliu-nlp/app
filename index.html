<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€æ˜“åœ°å›¾å¯¼èˆªç³»ç»Ÿ</title>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=19pC14ldf5XgThjPKscZQwIFfyV1ZYOQ"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 13px;
            opacity: 0.9;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
            overflow: hidden;
        }
        .control-panel {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .control-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .control-row:last-child {
            margin-bottom: 0;
        }
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        .search-input:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .btn {
            padding: 12px 24px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .btn-success.active {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }
        .btn-info.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .info-panel {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 12px 15px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
        }
        .info-panel.show {
            display: block;
        }
        .info-panel strong {
            color: #1976d2;
        }
        .info-accuracy {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            display: block;
        }
        .search-results {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            position: relative;
            z-index: 100;
        }
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        .search-result-item:hover {
            background: #f5f5f5;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        .search-result-address {
            font-size: 12px;
            color: #666;
        }
        .map-container {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .stats-panel {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }
        .stats-panel.show {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        .stat-item {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ ç®€æ˜“åœ°å›¾å¯¼èˆªç³»ç»Ÿ</h1>
        <p>å®æ—¶å®šä½ | ä½ç½®è·Ÿè¸ª | åœ°ç‚¹æœç´¢</p>
    </div>

    <div class="container">
        <div class="control-panel">
            <div class="control-row">
                <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢åœ°ç‚¹ï¼ˆå¦‚ï¼šå¤©å®‰é—¨ã€åŒ—äº¬å¤§å­¦ç­‰ï¼‰" />
                <button id="searchBtn" class="btn btn-primary">ğŸ” æœç´¢</button>
            </div>
            <div class="control-row">
                <button id="baiduLocationBtn" class="btn btn-success">ğŸ“ å¼€å§‹å®šä½</button>
                <button id="followBtn" class="btn btn-info" disabled>ğŸ¯ è‡ªåŠ¨è·Ÿéš</button>
                <button id="clearBtn" class="btn btn-primary">ğŸ—‘ï¸ æ¸…é™¤æ ‡è®°</button>
            </div>
            <div id="searchResults" class="search-results"></div>
            <div id="locationInfo" class="info-panel"></div>
        </div>

        <div class="stats-panel" id="statsPanel">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">ç§»åŠ¨è·ç¦»</div>
                    <div class="stat-value" id="totalDistance">0 m</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å½“å‰é€Ÿåº¦</div>
                    <div class="stat-value" id="currentSpeed">0 km/h</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å¹³å‡é€Ÿåº¦</div>
                    <div class="stat-value" id="avgSpeed">0 km/h</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å®šä½ç²¾åº¦</div>
                    <div class="stat-value" id="accuracy">-- m</div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script>
        // ========== åœ°å›¾åˆå§‹åŒ– ==========
        var map = new BMap.Map("map");
        var centerPoint = new BMap.Point(116.404, 39.915); // åŒ—äº¬å¤©å®‰é—¨
        map.centerAndZoom(centerPoint, 13);
        map.enableScrollWheelZoom(true);

        // æ·»åŠ æ§ä»¶
        map.addControl(new BMap.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT}));
        map.addControl(new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_RIGHT}));

        // ========== å…¨å±€å˜é‡ ==========
        var locationMarker = null;
        var locationCircle = null;
        var accuracyCircle = null;
        var isTracking = false;
        var isFollowing = false;
        var lastPosition = null;
        var currentHeading = 0;
        var searchMarker = null;
        var pathPolyline = null;
        var pathPoints = [];

        // ç»Ÿè®¡æ•°æ®
        var totalDistance = 0;
        var speedHistory = [];
        var startTime = null;

        // ========== å·¥å…·å‡½æ•° ==========
        function calculateDistance(lat1, lng1, lat2, lng2) {
            var R = 6371000; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateHeading(lat1, lng1, lat2, lng2) {
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var lat1Rad = lat1 * Math.PI / 180;
            var lat2Rad = lat2 * Math.PI / 180;
            
            var y = Math.sin(dLng) * Math.cos(lat2Rad);
            var x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                    Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
            
            var heading = Math.atan2(y, x) * 180 / Math.PI;
            return (heading + 360) % 360;
        }

        function assessLocationQuality(accuracy) {
            if (accuracy <= 10) {
                return {level: 'excellent', text: 'ä¼˜ç§€', color: '#28a745', emoji: 'ğŸŸ¢'};
            } else if (accuracy <= 30) {
                return {level: 'good', text: 'è‰¯å¥½', color: '#17a2b8', emoji: 'ğŸ”µ'};
            } else if (accuracy <= 50) {
                return {level: 'fair', text: 'ä¸€èˆ¬', color: '#ffc107', emoji: 'ğŸŸ¡'};
            } else if (accuracy <= 100) {
                return {level: 'poor', text: 'è¾ƒå·®', color: '#fd7e14', emoji: 'ğŸŸ '};
            } else {
                return {level: 'bad', text: 'å¾ˆå·®', color: '#dc3545', emoji: 'ğŸ”´'};
            }
        }

        function createLocationIcon(heading) {
            if (heading !== null && heading !== undefined && !isNaN(heading)) {
                return new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%234285f4;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%231a73e8;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='20' cy='20' r='18' fill='%234285f4' opacity='0.2'/%3E%3Ccircle cx='20' cy='20' r='12' fill='url(%23grad)'/%3E%3Ccircle cx='20' cy='20' r='6' fill='white'/%3E%3Cpath d='M 20 8 L 24 16 L 20 14 L 16 16 Z' fill='white' transform='rotate(" + heading + " 20 20)'/%3E%3C/svg%3E",
                    new BMap.Size(40, 40),
                    {anchor: new BMap.Size(20, 20)}
                );
            } else {
                return new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%234285f4;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%231a73e8;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='20' cy='20' r='18' fill='%234285f4' opacity='0.2'/%3E%3Ccircle cx='20' cy='20' r='12' fill='url(%23grad)'/%3E%3Ccircle cx='20' cy='20' r='6' fill='white'/%3E%3C/svg%3E",
                    new BMap.Size(40, 40),
                    {anchor: new BMap.Size(20, 20)}
                );
            }
        }

        function updateStats(speed, accuracy) {
            var statsPanel = document.getElementById('statsPanel');
            if (isTracking) {
                statsPanel.classList.add('show');
            }

            // æ›´æ–°æ€»è·ç¦»
            var distanceText = totalDistance < 1000 
                ? Math.round(totalDistance) + ' m' 
                : (totalDistance / 1000).toFixed(2) + ' km';
            document.getElementById('totalDistance').textContent = distanceText;

            // æ›´æ–°å½“å‰é€Ÿåº¦
            var speedKmh = speed ? (speed * 3.6).toFixed(1) : '0.0';
            document.getElementById('currentSpeed').textContent = speedKmh + ' km/h';

            // æ›´æ–°å¹³å‡é€Ÿåº¦
            if (speed && speed > 0) {
                speedHistory.push(speed);
                if (speedHistory.length > 10) {
                    speedHistory.shift();
                }
            }
            var avgSpeed = 0;
            if (speedHistory.length > 0) {
                avgSpeed = speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length;
            }
            document.getElementById('avgSpeed').textContent = (avgSpeed * 3.6).toFixed(1) + ' km/h';

            // æ›´æ–°ç²¾åº¦
            document.getElementById('accuracy').textContent = 'Â±' + Math.round(accuracy) + ' m';
        }

        function updateLocationInfo(lat, lng, accuracy, speed, heading, locationType) {
            var infoPanel = document.getElementById('locationInfo');
            var quality = assessLocationQuality(accuracy);

            var speedKmh = speed ? (speed * 3.6).toFixed(1) : '0.0';
            var directionText = '';
            
            if (heading !== null && heading !== undefined && !isNaN(heading)) {
                var directions = ['åŒ—', 'ä¸œåŒ—', 'ä¸œ', 'ä¸œå—', 'å—', 'è¥¿å—', 'è¥¿', 'è¥¿åŒ—'];
                var index = Math.round(heading / 45) % 8;
                directionText = '<br>ğŸ§­ æ–¹å‘ï¼š' + directions[index] + ' (' + Math.round(heading) + 'Â°)';
            }

            var locationTypeText = locationType ? '<br>ğŸ“¡ å®šä½æ–¹å¼ï¼š' + locationType : '';

            infoPanel.innerHTML = 
                '<strong>ğŸ“ å®æ—¶å®šä½ä¸­</strong><br>' +
                'åæ ‡ï¼š' + lat.toFixed(6) + ', ' + lng.toFixed(6) + '<br>' +
                'ğŸƒ é€Ÿåº¦ï¼š' + speedKmh + ' km/h' +
                directionText +
                '<br>' + quality.emoji + ' å®šä½è´¨é‡ï¼š' + quality.text +
                locationTypeText +
                '<span class="info-accuracy">å®šä½ç²¾åº¦ï¼šÂ±' + Math.round(accuracy) + 'ç±³</span>';
            infoPanel.classList.add('show');
        }

        // ========== å®šä½åŠŸèƒ½ ==========
        function processLocationUpdate(lat, lng, accuracy, speed, heading, locationType) {
            console.log('ğŸ“ ä½ç½®æ›´æ–° - çº¬åº¦:', lat.toFixed(6), 'ç»åº¦:', lng.toFixed(6), 'ç²¾åº¦:', accuracy + 'm', 'å®šä½æ–¹å¼:', locationType || 'GPS');

            var point = new BMap.Point(lng, lat);

            // è®¡ç®—ç§»åŠ¨è·ç¦»
            if (lastPosition) {
                var movedDistance = calculateDistance(lastPosition.lat, lastPosition.lng, lat, lng);
                if (movedDistance > 1) { // ç§»åŠ¨è¶…è¿‡1ç±³æ‰ç´¯è®¡
                    totalDistance += movedDistance;
                    
                    // æ·»åŠ åˆ°è·¯å¾„
                    pathPoints.push(point);
                    if (pathPolyline) {
                        map.removeOverlay(pathPolyline);
                    }
                    pathPolyline = new BMap.Polyline(pathPoints, {
                        strokeColor: "#667eea",
                        strokeWeight: 4,
                        strokeOpacity: 0.8
                    });
                    map.addOverlay(pathPolyline);
                }

                // è®¡ç®—æ–¹å‘
                if (movedDistance > 1) {
                    var calculatedHeading = calculateHeading(
                        lastPosition.lat, 
                        lastPosition.lng, 
                        lat, 
                        lng
                    );
                    currentHeading = heading !== null && heading !== undefined && !isNaN(heading) 
                        ? heading 
                        : calculatedHeading;
                }
            } else {
                // é¦–æ¬¡å®šä½
                startTime = Date.now();
                pathPoints = [point];
            }

            lastPosition = {lat: lat, lng: lng};

            // æ›´æ–°åœ°å›¾æ ‡è®°
            if (locationMarker) {
                map.removeOverlay(locationMarker);
            }
            if (locationCircle) {
                map.removeOverlay(locationCircle);
            }

            var icon = createLocationIcon(currentHeading);
            locationMarker = new BMap.Marker(point, {icon: icon});
            map.addOverlay(locationMarker);

            // å®šä½è´¨é‡è¯„ä¼°ï¼Œè°ƒæ•´åœ†åœˆé¢œè‰²
            var quality = assessLocationQuality(accuracy);
            locationCircle = new BMap.Circle(point, accuracy, {
                strokeColor: quality.color,
                strokeWeight: 2,
                strokeOpacity: 0.5,
                fillColor: quality.color,
                fillOpacity: 0.15
            });
            map.addOverlay(locationCircle);

            // æ›´æ–°ä¿¡æ¯
            updateLocationInfo(lat, lng, accuracy, speed, currentHeading, locationType);
            updateStats(speed, accuracy);

            // è‡ªåŠ¨è·Ÿéš
            if (isFollowing) {
                map.panTo(point);
            } else if (!lastPosition || pathPoints.length === 1) {
                // é¦–æ¬¡å®šä½æ—¶å±…ä¸­
                map.centerAndZoom(point, 16);
            }

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            var speedKmh = speed ? (speed * 3.6).toFixed(1) : '0.0';
            var infoWindow = new BMap.InfoWindow(
                "<div style='padding:10px;'>" +
                "<h4 style='margin:0 0 8px 0;color:#4285f4;'>ğŸ“ å½“å‰ä½ç½®</h4>" +
                "<p style='margin:0;font-size:13px;color:#666;'>çº¬åº¦ï¼š" + lat.toFixed(6) + "</p>" +
                "<p style='margin:0;font-size:13px;color:#666;'>ç»åº¦ï¼š" + lng.toFixed(6) + "</p>" +
                "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>ç²¾åº¦ï¼šÂ±" + Math.round(accuracy) + "ç±³ " + quality.emoji + "</p>" +
                "<p style='margin:4px 0 0 0;font-size:13px;color:" + quality.color + ";'><strong>å®šä½è´¨é‡ï¼š" + quality.text + "</strong></p>" +
                (locationType ? "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>å®šä½æ–¹å¼ï¼š" + locationType + "</p>" : "") +
                "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>é€Ÿåº¦ï¼š" + speedKmh + " km/h</p>" +
                (currentHeading ? "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>æ–¹å‘ï¼š" + Math.round(currentHeading) + "Â°</p>" : "") +
                "</div>",
                {width: 280}
            );

            locationMarker.addEventListener('click', function() {
                this.openInfoWindow(infoWindow);
            });
        }

        function onLocationError(error) {
            var errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šç”¨æˆ·æ‹’ç»äº†å®šä½è¯·æ±‚';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šè¯·æ±‚è¶…æ—¶';
                    break;
                default:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šæœªçŸ¥é”™è¯¯';
            }
            
            var infoPanel = document.getElementById('locationInfo');
            infoPanel.innerHTML = '<strong>' + errorMsg + '</strong><br>' +
                '<span class="info-accuracy">è¯·ç¡®ä¿å·²å…è®¸æµè§ˆå™¨è®¿é—®ä½ç½®ä¿¡æ¯ï¼Œå¹¶å¼€å¯GPS</span>';
            infoPanel.classList.add('show');

            console.error('å®šä½é”™è¯¯:', error);
        }

        function toggleFollow() {
            if (!isTracking) {
                return;
            }

            isFollowing = !isFollowing;
            var followBtn = document.getElementById('followBtn');
            
            if (isFollowing) {
                followBtn.classList.add('active');
                followBtn.innerHTML = 'ğŸ¯ è·Ÿéšä¸­';
                if (lastPosition) {
                    var point = new BMap.Point(lastPosition.lng, lastPosition.lat);
                    map.panTo(point);
                }
                console.log('âœ… è‡ªåŠ¨è·Ÿéšå·²å¼€å¯');
            } else {
                followBtn.classList.remove('active');
                followBtn.innerHTML = 'ğŸ—ºï¸ è‡ªç”±æµè§ˆ';
                console.log('â¸ï¸ è‡ªåŠ¨è·Ÿéšå·²å…³é—­');
            }
        }

        function clearMarkers() {
            if (searchMarker) {
                map.removeOverlay(searchMarker);
                searchMarker = null;
            }
            if (pathPolyline) {
                map.removeOverlay(pathPolyline);
                pathPolyline = null;
            }
            pathPoints = [];
            totalDistance = 0;
            speedHistory = [];
            updateStats(0, 0);
            console.log('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰æ ‡è®°å’Œè·¯å¾„');
        }

        // ========== æœç´¢åŠŸèƒ½ ==========
        var localSearch = new BMap.LocalSearch(map, {
            onSearchComplete: function(results) {
                var resultsPanel = document.getElementById('searchResults');
                resultsPanel.innerHTML = '';
                
                if (localSearch.getStatus() == BMAP_STATUS_SUCCESS) {
                    var resultsHtml = '';
                    var resultsCount = Math.min(results.getCurrentNumPois(), 5);
                    
                    for (var i = 0; i < resultsCount; i++) {
                        var poi = results.getPoi(i);
                        resultsHtml += '<div class="search-result-item" data-index="' + i + '">' +
                            '<div class="search-result-title">' + poi.title + '</div>' +
                            '<div class="search-result-address">' + poi.address + '</div>' +
                            '</div>';
                    }
                    
                    resultsPanel.innerHTML = resultsHtml;
                    resultsPanel.style.display = 'block';
                    
                    var resultItems = resultsPanel.getElementsByClassName('search-result-item');
                    for (var i = 0; i < resultItems.length; i++) {
                        resultItems[i].addEventListener('click', function() {
                            var index = parseInt(this.getAttribute('data-index'));
                            var poi = results.getPoi(index);
                            showSearchResult(poi);
                            resultsPanel.style.display = 'none';
                        });
                    }
                } else {
                    resultsPanel.innerHTML = '<div class="search-result-item">æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</div>';
                    resultsPanel.style.display = 'block';
                }
            }
        });

        function showSearchResult(poi) {
            if (searchMarker) {
                map.removeOverlay(searchMarker);
            }
            
            var point = poi.point;
            var icon = new BMap.Icon(
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='42'%3E%3Cpath d='M16,0 C7.2,0 0,7.2 0,16 C0,28 16,42 16,42 S32,28 32,16 C32,7.2 24.8,0 16,0 Z' fill='%23667eea'/%3E%3Ccircle cx='16' cy='16' r='8' fill='white'/%3E%3C/svg%3E",
                new BMap.Size(32, 42)
            );
            
            searchMarker = new BMap.Marker(point, {icon: icon});
            map.addOverlay(searchMarker);
            
            var infoWindow = new BMap.InfoWindow(
                "<div style='padding:12px;max-width:300px;'>" +
                "<h4 style='margin:0 0 10px 0;color:#667eea;font-size:16px;'>ğŸ“ " + poi.title + "</h4>" +
                "<p style='margin:0 0 8px 0;color:#666;font-size:14px;'><strong>åœ°å€ï¼š</strong>" + poi.address + "</p>" +
                (poi.phoneNumber ? "<p style='margin:0;color:#666;font-size:14px;'><strong>ç”µè¯ï¼š</strong>" + poi.phoneNumber + "</p>" : "") +
                "</div>",
                {width: 320}
            );
            
            searchMarker.openInfoWindow(infoWindow);
            map.centerAndZoom(point, 15);
            
            searchMarker.setAnimation(BMAP_ANIMATION_BOUNCE);
            setTimeout(function() {
                searchMarker.setAnimation(null);
            }, 2000);
        }

        // ========== åŸç”Ÿ GPS å®šä½ï¼ˆä¸»è¦æ–¹æ¡ˆï¼‰==========
        var nativeWatchId = null;

        // WGS84 è½¬ BD09 åæ ‡è½¬æ¢
        function wgs84ToBd09(lat, lng) {
            var x_PI = 3.14159265358979324 * 3000.0 / 180.0;
            var PI = 3.1415926535897932384626;
            var a = 6378245.0;
            var ee = 0.00669342162296594323;

            function transformLat(lng, lat) {
                var ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat + 0.1 * lng * lat + 0.2 * Math.sqrt(Math.abs(lng));
                ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
                ret += (20.0 * Math.sin(lat * PI) + 40.0 * Math.sin(lat / 3.0 * PI)) * 2.0 / 3.0;
                ret += (160.0 * Math.sin(lat / 12.0 * PI) + 320 * Math.sin(lat * PI / 30.0)) * 2.0 / 3.0;
                return ret;
            }

            function transformLng(lng, lat) {
                var ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng + 0.1 * lng * lat + 0.1 * Math.sqrt(Math.abs(lng));
                ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
                ret += (20.0 * Math.sin(lng * PI) + 40.0 * Math.sin(lng / 3.0 * PI)) * 2.0 / 3.0;
                ret += (150.0 * Math.sin(lng / 12.0 * PI) + 300.0 * Math.sin(lng / 30.0 * PI)) * 2.0 / 3.0;
                return ret;
            }

            // WGS84 to GCJ02
            var dlat = transformLat(lng - 105.0, lat - 35.0);
            var dlng = transformLng(lng - 105.0, lat - 35.0);
            var radlat = lat / 180.0 * PI;
            var magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            var sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
            var gcjLat = lat + dlat;
            var gcjLng = lng + dlng;

            // GCJ02 to BD09
            var z = Math.sqrt(gcjLng * gcjLng + gcjLat * gcjLat) + 0.00002 * Math.sin(gcjLat * x_PI);
            var theta = Math.atan2(gcjLat, gcjLng) + 0.000003 * Math.cos(gcjLng * x_PI);
            var bd09Lng = z * Math.cos(theta) + 0.0065;
            var bd09Lat = z * Math.sin(theta) + 0.006;

            return {lat: bd09Lat, lng: bd09Lng};
        }

        function startNativeTracking() {
            if (!navigator.geolocation) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ï¼Œå°†ä½¿ç”¨ç™¾åº¦å®šä½');
                console.error('âŒ æµè§ˆå™¨ä¸æ”¯æŒåŸç”Ÿå®šä½');
                startBaiduTracking();
                return;
            }

            isTracking = true;
            isFollowing = true;
            
            var baiduBtn = document.getElementById('baiduLocationBtn');
            baiduBtn.classList.add('active');
            baiduBtn.innerHTML = 'ğŸ”´ åœæ­¢';

            var followBtn = document.getElementById('followBtn');
            followBtn.classList.add('active');
            followBtn.innerHTML = 'ğŸ¯ è·Ÿéšä¸­';
            followBtn.disabled = false;

            console.log('ğŸ¯ å¼€å§‹åŸç”ŸGPSå®šä½è¿½è¸ª...');

            nativeWatchId = navigator.geolocation.watchPosition(
                function(position) {
                    var wgsLat = position.coords.latitude;
                    var wgsLng = position.coords.longitude;
                    var accuracy = position.coords.accuracy;
                    var speed = position.coords.speed;
                    var heading = position.coords.heading;

                    // è½¬æ¢ä¸ºç™¾åº¦åæ ‡ç³»
                    var bdCoords = wgs84ToBd09(wgsLat, wgsLng);

                    console.log('ğŸ“ GPSå®šä½æˆåŠŸ - WGS84:', wgsLat.toFixed(6), wgsLng.toFixed(6), 
                               '-> BD09:', bdCoords.lat.toFixed(6), bdCoords.lng.toFixed(6), 
                               'ç²¾åº¦:', accuracy + 'm');

                    processLocationUpdate(bdCoords.lat, bdCoords.lng, accuracy, speed, heading, 'GPS');
                },
                function(error) {
                    var errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'âŒ GPSå®šä½å¤±è´¥ï¼šç”¨æˆ·æ‹’ç»äº†å®šä½è¯·æ±‚ï¼Œåˆ‡æ¢åˆ°ç™¾åº¦å®šä½';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'âŒ GPSå®šä½å¤±è´¥ï¼šä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œåˆ‡æ¢åˆ°ç™¾åº¦å®šä½';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'âŒ GPSå®šä½å¤±è´¥ï¼šè¯·æ±‚è¶…æ—¶ï¼Œåˆ‡æ¢åˆ°ç™¾åº¦å®šä½';
                            break;
                        default:
                            errorMsg = 'âŒ GPSå®šä½å¤±è´¥ï¼šæœªçŸ¥é”™è¯¯ï¼Œåˆ‡æ¢åˆ°ç™¾åº¦å®šä½';
                    }
                    
                    console.error(errorMsg, error);
                    
                    var infoPanel = document.getElementById('locationInfo');
                    infoPanel.innerHTML = '<strong>' + errorMsg + '</strong>';
                    infoPanel.classList.add('show');

                    // åœæ­¢åŸç”Ÿå®šä½ï¼Œåˆ‡æ¢åˆ°ç™¾åº¦å®šä½
                    stopNativeTracking();
                    setTimeout(function() {
                        startBaiduTracking();
                    }, 1000);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 27000,
                    maximumAge: 0
                }
            );

            console.log('âš™ï¸ GPSé…ç½®: é«˜ç²¾åº¦æ¨¡å¼, è¶…æ—¶27s, å®æ—¶è¿½è¸ª');
        }

        function stopNativeTracking() {
            if (nativeWatchId !== null) {
                navigator.geolocation.clearWatch(nativeWatchId);
                nativeWatchId = null;
            }

            isTracking = false;
            isFollowing = false;
            
            var baiduBtn = document.getElementById('baiduLocationBtn');
            baiduBtn.classList.remove('active');
            baiduBtn.innerHTML = 'ğŸ“ å¼€å§‹å®šä½';

            var followBtn = document.getElementById('followBtn');
            followBtn.classList.remove('active');
            followBtn.innerHTML = 'ğŸ¯ è‡ªåŠ¨è·Ÿéš';
            followBtn.disabled = true;

            var infoPanel = document.getElementById('locationInfo');
            infoPanel.classList.remove('show');

            console.log('â¹ï¸ GPSå®šä½å·²åœæ­¢');
        }

        // ç™¾åº¦åœ°å›¾å®šä½ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        var geolocation = new BMap.Geolocation();
        var baiduLocationInterval = null;

        function startBaiduTracking() {
            isTracking = true;
            isFollowing = true;
            
            var baiduBtn = document.getElementById('baiduLocationBtn');
            baiduBtn.classList.add('active');
            baiduBtn.innerHTML = 'ğŸ”´ åœæ­¢';

            var followBtn = document.getElementById('followBtn');
            followBtn.classList.add('active');
            followBtn.innerHTML = 'ğŸ¯ è·Ÿéšä¸­';
            followBtn.disabled = false;

            console.log('ğŸ—ºï¸ å¼€å§‹ç™¾åº¦åœ°å›¾å®šä½ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰...');

            function getBaiduLocation() {
                geolocation.getCurrentPosition(function(r) {
                    if (this.getStatus() == BMAP_STATUS_SUCCESS) {
                        var lat = r.point.lat;
                        var lng = r.point.lng;
                        var accuracy = r.accuracy || 50;
                        
                        console.log('ğŸ—ºï¸ ç™¾åº¦å®šä½æˆåŠŸ - çº¬åº¦:', lat.toFixed(6), 'ç»åº¦:', lng.toFixed(6), 'ç²¾åº¦:', accuracy + 'm');
                        
                        // ç™¾åº¦å®šä½è¿”å›çš„å·²ç»æ˜¯BD09åæ ‡ï¼Œä¸éœ€è¦è½¬æ¢
                        processLocationUpdate(lat, lng, accuracy, 0, null, 'ç™¾åº¦å®šä½');
                    } else {
                        console.error('âŒ ç™¾åº¦å®šä½å¤±è´¥:', this.getStatus());
                    }
                }, {enableHighAccuracy: true});
            }

            // ç«‹å³æ‰§è¡Œä¸€æ¬¡
            getBaiduLocation();
            
            // æ¯2ç§’æ›´æ–°ä¸€æ¬¡ä½ç½®
            baiduLocationInterval = setInterval(getBaiduLocation, 2000);
        }

        function stopBaiduTracking() {
            if (baiduLocationInterval) {
                clearInterval(baiduLocationInterval);
                baiduLocationInterval = null;
            }

            isTracking = false;
            isFollowing = false;
            
            var baiduBtn = document.getElementById('baiduLocationBtn');
            baiduBtn.classList.remove('active');
            baiduBtn.innerHTML = 'ğŸ“ å¼€å§‹å®šä½';

            var followBtn = document.getElementById('followBtn');
            followBtn.classList.remove('active');
            followBtn.innerHTML = 'ğŸ¯ è‡ªåŠ¨è·Ÿéš';
            followBtn.disabled = true;

            var infoPanel = document.getElementById('locationInfo');
            infoPanel.classList.remove('show');

            console.log('â¹ï¸ ç™¾åº¦å®šä½å·²åœæ­¢');
        }

        // ========== äº‹ä»¶ç›‘å¬ ==========
        document.getElementById('baiduLocationBtn').addEventListener('click', function() {
            if (isTracking) {
                // åœæ­¢æ‰€æœ‰å®šä½
                if (nativeWatchId !== null) {
                    stopNativeTracking();
                }
                if (baiduLocationInterval !== null) {
                    stopBaiduTracking();
                }
            } else {
                // ä¼˜å…ˆä½¿ç”¨åŸç”ŸGPSå®šä½
                startNativeTracking();
            }
        });

        document.getElementById('followBtn').addEventListener('click', function() {
            toggleFollow();
        });

        document.getElementById('clearBtn').addEventListener('click', function() {
            clearMarkers();
        });

        document.getElementById('searchBtn').addEventListener('click', function() {
            var keyword = document.getElementById('searchInput').value.trim();
            if (keyword) {
                localSearch.search(keyword);
            } else {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
            }
        });

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        // ç‚¹å‡»åœ°å›¾éšè—æœç´¢ç»“æœ
        map.addEventListener('click', function() {
            document.getElementById('searchResults').style.display = 'none';
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—æœç´¢ç»“æœ
        document.addEventListener('click', function(e) {
            var resultsPanel = document.getElementById('searchResults');
            var searchInput = document.getElementById('searchInput');
            var searchBtn = document.getElementById('searchBtn');
            if (e.target !== resultsPanel && e.target !== searchInput && e.target !== searchBtn) {
                resultsPanel.style.display = 'none';
            }
        });

        // é¡µé¢å…³é—­æ—¶åœæ­¢å®šä½
        window.addEventListener('beforeunload', function() {
            if (nativeWatchId !== null) {
                stopNativeTracking();
            }
            if (baiduLocationInterval) {
                stopBaiduTracking();
            }
        });

        console.log('âœ… åœ°å›¾å¯¼èˆªç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    </script>
</body>
</html>
