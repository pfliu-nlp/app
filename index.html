<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±±ä¸œå¾·å·é©¬æ‹‰æ¾è·¯çº¿è§„åˆ’ - 43å…¬é‡Œç¯åŸè·‘</title>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=19pC14ldf5XgThjPKscZQwIFfyV1ZYOQ"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }
        .info-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .info-panel h2 {
            color: #FF6B6B;
            margin-bottom: 15px;
            font-size: 20px;
            border-left: 4px solid #FF6B6B;
            padding-left: 10px;
        }
        .route-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .info-card {
            background: linear-gradient(135deg, #FF6B6B15 0%, #FF8E5315 100%);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #FF6B6B;
        }
        .info-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .info-card p {
            font-size: 20px;
            color: #333;
            font-weight: bold;
        }
        .checkpoints {
            margin-top: 15px;
        }
        .checkpoint-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: all 0.3s;
        }
        .checkpoint-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        .checkpoint-number {
            background: #FF6B6B;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .checkpoint-name {
            font-weight: bold;
            color: #333;
            margin-right: 10px;
            flex: 1;
        }
        .checkpoint-distance {
            color: #666;
            font-size: 14px;
            margin-left: auto;
        }
        #map {
            width: 100%;
            height: 700px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: relative;
        }
        .map-search-container {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .map-search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #FF6B6B;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }
        .map-search-input:focus {
            border-color: #FF8E53;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }
        .map-search-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .map-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        .map-search-btn:active {
            transform: translateY(0);
        }
        .search-result-panel {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }
        .search-result-item:hover {
            background: #f5f5f5;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        .search-result-address {
            font-size: 12px;
            color: #666;
        }
        .location-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .location-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        .location-btn:active {
            transform: translateY(0);
        }
        .location-btn.active {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .location-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
            font-size: 14px;
        }
        .location-info.show {
            display: block;
        }
        .location-info strong {
            color: #1976d2;
        }
        .location-accuracy {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .legend-icon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        .tips {
            background: #d1ecf1;
            border-left: 4px solid #0c5460;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }
        .tips h3 {
            color: #0c5460;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .tips ul {
            margin-left: 20px;
            color: #0c5460;
        }
        .tips li {
            margin-bottom: 5px;
        }
        .route-direction {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .route-direction h3 {
            color: #28a745;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .route-direction p {
            color: #155724;
            margin: 5px 0;
            line-height: 1.6;
        }
        .route-direction strong {
            color: #28a745;
        }
        
        /* å¤šäººä½ç½®å…±äº«æ ·å¼ */
        .share-panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .share-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        .nickname-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #FF6B6B;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }
        .nickname-input:focus {
            border-color: #FF8E53;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }
        .share-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        .share-btn.active {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .online-users {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .online-users h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
            color: #666;
        }
        .user-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
        }
        .user-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .user-name {
            flex: 1;
            font-weight: bold;
            color: #333;
        }
        .user-distance {
            color: #666;
            font-size: 12px;
        }
        .firebase-status {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding: 6px 10px;
            background: #e3f2fd;
            border-radius: 4px;
            text-align: center;
        }
        .firebase-status.connected {
            background: #d4edda;
            color: #155724;
        }
        .firebase-status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸƒ å±±ä¸œå¾·å·é©¬æ‹‰æ¾è·¯çº¿è§„åˆ’</h1>
        <p>å…¨ç¨‹çº¦43å…¬é‡Œ | ç¯åŸè·¯çº¿ | ä½“éªŒå¾·å·åŸå¸‚é£å…‰</p>
    </div>

    <div class="container">
        <div class="info-panel">
            <div class="route-direction">
                <h3>ğŸ§­ è·¯çº¿ç‰¹è‰²ï¼šå¾·å·ç¯åŸé©¬æ‹‰æ¾</h3>
                <p><strong>è·¯çº¿æ¦‚è¿°ï¼š</strong>è¿™æ˜¯ä¸€æ¡ç¯ç»•å¾·å·å¸‚åŒºçš„é©¬æ‹‰æ¾è·¯çº¿ï¼Œå…¨ç¨‹çº¦43å…¬é‡Œï¼Œèµ·ç‚¹å’Œç»ˆç‚¹ä½äºåŒä¸€ä½ç½®ï¼Œå½¢æˆå®Œæ•´çš„é—­ç¯ã€‚</p>
                
                <p><strong>ğŸŒ† åŸå¸‚é£å…‰ï¼š</strong>è·¯çº¿ç©¿è¶Šå¾·å·å¸‚åŒºä¸»è¦åŒºåŸŸï¼Œå¯ä»¥æ¬£èµåˆ°å¾·å·çš„åŸå¸‚å»ºè®¾å’Œè‡ªç„¶é£å…‰ã€‚</p>
                
                <p><strong>âš ï¸ æ³¨æ„äº‹é¡¹ï¼š</strong>å»ºè®®æ—©æ™¨6:00-8:00å‡ºå‘ï¼Œé¿å¼€äº¤é€šé«˜å³°ã€‚æ³¨æ„äº¤é€šå®‰å…¨ï¼Œéµå®ˆäº¤é€šè§„åˆ™ã€‚</p>
            </div>
        </div>

        <div class="info-panel">
            <h2>ğŸ“Š è·¯çº¿æ¦‚å†µ</h2>
            <div class="route-info">
                <div class="info-card">
                    <h3>æ€»è·ç¦»</h3>
                    <p>43 km</p>
                </div>
                <div class="info-card">
                    <h3>è·¯çº¿ç±»å‹</h3>
                    <p>ç¯å½¢è·¯çº¿</p>
                </div>
                <div class="info-card">
                    <h3>å»ºè®®é…é€Ÿ</h3>
                    <p>5:30-6:00/km</p>
                </div>
                <div class="info-card">
                    <h3>é¢„è®¡ç”¨æ—¶</h3>
                    <p>3.5-4.5å°æ—¶</p>
                </div>
                <div class="info-card">
                    <h3>éš¾åº¦ç­‰çº§</h3>
                    <p>ä¸­ç­‰</p>
                </div>
                <div class="info-card">
                    <h3>æœ€ä½³å­£èŠ‚</h3>
                    <p>æ˜¥ç§‹ä¸¤å­£</p>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <h2>ğŸš© å…³é”®èŠ‚ç‚¹</h2>
            <div class="checkpoints" id="checkpointsList">
                <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="tips">
                <h3>ğŸ’¡ å®ç”¨è·‘æ­¥å»ºè®®</h3>
                <ul>
                    <li><strong>æœ€ä½³æ—¶é—´ï¼š</strong>å»ºè®®æ—©ä¸Š6:00-8:00å‡ºå‘ï¼Œé¿å¼€äº¤é€šé«˜å³°ï¼Œç©ºæ°”è´¨é‡è¾ƒå¥½ã€‚</li>
                    <li><strong>è¡¥ç»™å‡†å¤‡ï¼š</strong>æºå¸¦èƒ½é‡èƒ¶3-4æ”¯ã€ç›ä¸¸ã€æ°´å£¶ï¼ˆ750mlï¼‰ã€‚è·¯çº¿è®¾æœ‰è¡¥ç»™ç‚¹ï¼š
                        <ul style="margin-top: 5px;">
                            <li>ğŸª 5km - å¥¥è±å¹¿åœºï¼ˆè¡¥æ°´ï¼‰</li>
                            <li>ğŸª 10km - åŠ¨æ¤ç‰©å›­ï¼ˆè¡¥æ°´+å…¬å•ï¼‰</li>
                        </ul>
                    </li>
                    <li><strong>é‡è¦åœ°æ ‡ï¼š</strong>
                        <ul style="margin-top: 5px;">
                            <li>ğŸŒ‰ å‡æ²³å¤§æ¡¥ - æ³¨æ„è½¬è¾…è·¯</li>
                            <li>ğŸ¯ 15km - æ°‘æ—å…¬å›­</li>
                            <li>ğŸ´ 20km - é©¬æœ¯ä¿±ä¹éƒ¨</li>
                        </ul>
                    </li>
                    <li><strong>é…é€Ÿç­–ç•¥ï¼š</strong>å‰15kmæ§åˆ¶åœ¨5:45-6:00/kmï¼Œä¸­æ®µ15-30kmå¯æé€Ÿè‡³5:30-5:45/kmï¼Œæœ€å13kmæ ¹æ®ä½“åŠ›è°ƒæ•´ã€‚</li>
                    <li><strong>å®‰å…¨æ³¨æ„ï¼š</strong>æ³¨æ„äº¤é€šå®‰å…¨ï¼Œéµå®ˆäº¤é€šè§„åˆ™ã€‚åœ¨å‡æ²³å¤§æ¡¥å¤„æ³¨æ„è½¬è¾…è·¯æ ‡è¯†ã€‚å»ºè®®ç»“ä¼´è€Œè¡Œï¼Œæºå¸¦æ‰‹æœºä¿æŒè”ç³»ã€‚</li>
                    <li><strong>è£…å¤‡å»ºè®®ï¼š</strong>ç©¿ç¼“å†²æ€§å¥½çš„è·‘é‹ï¼Œæ ¹æ®å­£èŠ‚å‡†å¤‡åˆé€‚çš„è¿åŠ¨æœè£…ã€‚å¤å­£æ³¨æ„é˜²æ™’å’Œè¡¥æ°´ã€‚</li>
                    <li><strong>å¤©æ°”å…³æ³¨ï¼š</strong>å‡ºå‘å‰æŸ¥çœ‹å¤©æ°”é¢„æŠ¥ï¼Œé¿å…åœ¨æç«¯å¤©æ°”æ¡ä»¶ä¸‹è·‘æ­¥ã€‚</li>
                </ul>
            </div>
        </div>

        <div class="info-panel">
            <h2>ğŸ—ºï¸ è·¯çº¿åœ°å›¾</h2>
            
            <!-- å¤šäººä½ç½®å…±äº«é¢æ¿ -->
            <div class="share-panel">
                <div class="share-controls">
                    <input type="text" id="nicknameInput" class="nickname-input" placeholder="è¾“å…¥ä½ çš„æ˜µç§°ï¼ˆå¦‚ï¼šå°æ˜ï¼‰" maxlength="20" />
                    <button id="shareBtn" class="share-btn">ğŸŒ å¼€å§‹å…±äº«ä½ç½®</button>
                </div>
                <div id="firebaseStatus" class="firebase-status">â³ æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
                <div id="onlineUsers" class="online-users" style="display: none;">
                    <h4>ğŸ“ åœ¨çº¿ç”¨æˆ· (<span id="userCount">0</span>)</h4>
                    <div id="userList"></div>
                </div>
            </div>
            
            <div class="map-search-container">
                <input type="text" id="searchInput" class="map-search-input" placeholder="æœç´¢åœ°ç‚¹ï¼ˆå¦‚ï¼šå¾·å·å¸‚æ”¿åºœã€å¾·å·å­¦é™¢ç­‰ï¼‰" />
                <button id="searchBtn" class="map-search-btn">ğŸ” æœç´¢</button>
                <button id="locationBtn" class="location-btn">ğŸ“ å®šä½</button>
            </div>
            <div id="locationInfo" class="location-info"></div>
            <div id="searchResults" class="search-result-panel"></div>
            <div id="map"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-icon" style="background: #FF6B6B;"></div>
                    <span>è·‘æ­¥è·¯çº¿</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #28a745;"></div>
                    <span>èµ·ç‚¹/ç»ˆç‚¹</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #dc3545;"></div>
                    <span>å…³é”®èŠ‚ç‚¹ï¼ˆæ¯10kmï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #FFA500;"></div>
                    <span>ğŸª è¡¥ç»™ç‚¹</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon" style="background: #9C27B0;"></div>
                    <span>ğŸ¯ é‡è¦åœ°æ ‡</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== Firebase é…ç½®å’Œåˆå§‹åŒ– ==========
        const firebaseConfig = {
          apiKey: "AIzaSyCVCpHY0yIj617UugtaN1iIGncoy9Ks3LI",
          authDomain: "beijing-marathon-tracker.firebaseapp.com",
          databaseURL: "https://beijing-marathon-tracker-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "beijing-marathon-tracker",
          storageBucket: "beijing-marathon-tracker.firebasestorage.app",
          messagingSenderId: "245823130801",
          appId: "1:245823130801:web:d661ada76dc1e831afe690",
          measurementId: "G-XL6V9Z467E"
        };

        // åˆå§‹åŒ– Firebase
        let firebaseApp = null;
        let database = null;
        let isFirebaseEnabled = false;
        
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseEnabled = true;
                console.log("âœ… Firebase åˆå§‹åŒ–æˆåŠŸ");
            } else {
                console.warn("âš ï¸ Firebase é…ç½®æœªè®¾ç½®ï¼Œå¤šäººå…±äº«åŠŸèƒ½å°†è¢«ç¦ç”¨");
            }
        } catch (error) {
            console.error("âŒ Firebase åˆå§‹åŒ–å¤±è´¥:", error);
            isFirebaseEnabled = false;
        }

        // å…³é”®è¡¥ç»™ç‚¹å’Œåœ°æ ‡ï¼ˆæ ¹æ®ç”¨æˆ·æä¾›çš„ä¿¡æ¯ï¼‰
        var keyLocations = [
            {
                name: "å¥¥è±å¹¿åœº",
                distance: 5,
                type: "supply",
                icon: "ğŸª",
                facilities: ["è¡¥æ°´"],
                description: "5å…¬é‡Œè¡¥ç»™ç‚¹ - å¥¥è±å¹¿åœº",
                color: "#FFA500"
            },
            {
                name: "åŠ¨æ¤ç‰©å›­",
                distance: 10,
                type: "supply",
                icon: "ğŸª",
                facilities: ["è¡¥æ°´", "å…¬å•"],
                description: "10å…¬é‡Œè¡¥ç»™ç‚¹ - åŠ¨æ¤ç‰©å›­",
                color: "#FFA500"
            },
            {
                name: "å‡æ²³å¤§æ¡¥",
                distance: null, // å°†æ ¹æ®è·¯çº¿è‡ªåŠ¨è®¡ç®—
                type: "landmark",
                icon: "ğŸŒ‰",
                facilities: ["è½¬è¾…è·¯"],
                description: "é‡è¦åœ°æ ‡ - å‡æ²³å¤§æ¡¥ï¼ˆè½¬è¾…è·¯ï¼‰",
                color: "#9C27B0"
            },
            {
                name: "æ°‘æ—å…¬å›­",
                distance: 15,
                type: "landmark",
                icon: "ğŸ¯",
                facilities: [],
                description: "15å…¬é‡Œåœ°æ ‡ - æ°‘æ—å…¬å›­",
                color: "#9C27B0"
            },
            {
                name: "é©¬æœ¯ä¿±ä¹éƒ¨",
                distance: 20,
                type: "landmark",
                icon: "ğŸ´",
                facilities: [],
                description: "20å…¬é‡Œåœ°æ ‡ - é©¬æœ¯ä¿±ä¹éƒ¨",
                color: "#9C27B0"
            }
        ];
        
        // ä»GPXæ–‡ä»¶è§£æçš„è·¯çº¿ç‚¹ï¼ˆå»é‡åï¼‰
        // æ¯ä¸ªç‚¹éƒ½ä¼šåœ¨ç‚¹å‡»æ—¶é€šè¿‡ç™¾åº¦åœ°å›¾APIè‡ªåŠ¨è·å–è¯¦ç»†åœ°å€
        var routePoints = [
            {lat: 37.445949, lng: 116.349171, name: "èµ·ç‚¹/ç»ˆç‚¹", desc: "å¾·å·é©¬æ‹‰æ¾èµ·ç‚¹", type: "start"},
            {lat: 37.418684, lng: 116.348494, name: "åŒ—æ®µ1", desc: "å‘å—è¡Œè¿›", type: "checkpoint"},
            {lat: 37.418216, lng: 116.371764, name: "ä¸œåŒ—è½¬è§’", desc: "å‘ä¸œè½¬å‘", type: "checkpoint"},
            {lat: 37.399920, lng: 116.371321, name: "ä¸œæ®µ1", desc: "ä¸œä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.400438, lng: 116.361017, name: "ä¸œæ®µ2", desc: "ç»§ç»­å‘å—", type: "checkpoint"},
            {lat: 37.397594, lng: 116.357238, name: "ä¸œæ®µ3", desc: "ä¸œä¾§ä¸­æ®µ", type: "checkpoint"},
            {lat: 37.387509, lng: 116.355092, name: "ä¸œæ®µ4", desc: "ä¸œä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.378152, lng: 116.353460, name: "ä¸œæ®µ5", desc: "ä¸œä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.368791, lng: 116.349125, name: "ä¸œå—æ®µ1", desc: "è½¬å‘ä¸œå—", type: "checkpoint"},
            {lat: 37.357442, lng: 116.341535, name: "ä¸œå—æ®µ2", desc: "ä¸œå—æ–¹å‘", type: "checkpoint"},
            {lat: 37.346334, lng: 116.339146, name: "ä¸œå—æ®µ3", desc: "ç»§ç»­ä¸œå—", type: "checkpoint"},
            {lat: 37.344448, lng: 116.339008, name: "å—æ®µ1", desc: "å—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.344062, lng: 116.341999, name: "å—æ®µ2", desc: "å—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.338728, lng: 116.339525, name: "å—æ®µ3", desc: "å—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.336356, lng: 116.334776, name: "å—æ®µ4", desc: "å—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.334020, lng: 116.328076, name: "å—æ®µ5", desc: "å—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.329992, lng: 116.323250, name: "è¥¿å—æ®µ1", desc: "è½¬å‘è¥¿å—", type: "checkpoint"},
            {lat: 37.325326, lng: 116.320658, name: "è¥¿å—æ®µ2", desc: "è¥¿å—æ–¹å‘", type: "checkpoint"},
            {lat: 37.322446, lng: 116.314359, name: "è¥¿å—æ®µ3", desc: "ç»§ç»­è¥¿å—", type: "checkpoint"},
            {lat: 37.322683, lng: 116.306259, name: "è¥¿å—è½¬è§’", desc: "å‘è¥¿è½¬å‘", type: "checkpoint"},
            {lat: 37.326156, lng: 116.300235, name: "è¥¿æ®µ1", desc: "è¥¿ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.327652, lng: 116.299077, name: "è¥¿æ®µ2", desc: "è¥¿ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.334189, lng: 116.285662, name: "æœ€è¥¿ç‚¹", desc: "è·¯çº¿æœ€è¥¿ç«¯", type: "checkpoint"},
            {lat: 37.333646, lng: 116.285223, name: "è¥¿æ®µ3", desc: "å¼€å§‹è¿”å›", type: "checkpoint"},
            {lat: 37.327397, lng: 116.298477, name: "è¥¿æ®µ4", desc: "è¥¿ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.325838, lng: 116.299639, name: "è¥¿æ®µ5", desc: "è¥¿ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.322331, lng: 116.305981, name: "è¥¿åŒ—æ®µ1", desc: "è½¬å‘è¥¿åŒ—", type: "checkpoint"},
            {lat: 37.321903, lng: 116.314482, name: "è¥¿åŒ—æ®µ2", desc: "è¥¿åŒ—æ–¹å‘", type: "checkpoint"},
            {lat: 37.324848, lng: 116.321179, name: "è¥¿åŒ—æ®µ3", desc: "ç»§ç»­è¥¿åŒ—", type: "checkpoint"},
            {lat: 37.329703, lng: 116.324013, name: "è¥¿åŒ—æ®µ4", desc: "è¥¿åŒ—è·¯æ®µ", type: "checkpoint"},
            {lat: 37.333572, lng: 116.328396, name: "è¥¿åŒ—æ®µ5", desc: "è¥¿åŒ—è·¯æ®µ", type: "checkpoint"},
            {lat: 37.336038, lng: 116.334907, name: "è¥¿åŒ—æ®µ6", desc: "è¥¿åŒ—è·¯æ®µ", type: "checkpoint"},
            {lat: 37.338511, lng: 116.340094, name: "åŒ—æ®µ2", desc: "å‘åŒ—è¡Œè¿›", type: "checkpoint"},
            {lat: 37.344481, lng: 116.343008, name: "åŒ—æ®µ3", desc: "åŒ—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.345029, lng: 116.339581, name: "åŒ—æ®µ4", desc: "åŒ—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.357511, lng: 116.342335, name: "åŒ—æ®µ5", desc: "åŒ—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.368617, lng: 116.349756, name: "åŒ—æ®µ6", desc: "åŒ—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.378202, lng: 116.354104, name: "åŒ—æ®µ7", desc: "åŒ—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.387505, lng: 116.355705, name: "åŒ—æ®µ8", desc: "åŒ—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.397251, lng: 116.357579, name: "åŒ—æ®µ9", desc: "åŒ—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.400104, lng: 116.361335, name: "åŒ—æ®µ10", desc: "åŒ—ä¾§è·¯æ®µ", type: "checkpoint"},
            {lat: 37.399457, lng: 116.371404, name: "ä¸œåŒ—æ®µ", desc: "ä¸œåŒ—æ–¹å‘", type: "checkpoint"},
            {lat: 37.418379, lng: 116.372242, name: "ä¸œåŒ—è§’", desc: "å‘åŒ—è½¬å‘", type: "checkpoint"},
            {lat: 37.419216, lng: 116.349244, name: "åŒ—æ®µ11", desc: "æœ€åå†²åˆº", type: "checkpoint"},
            {lat: 37.445720, lng: 116.349799, name: "ç»ˆç‚¹", desc: "å®Œæˆå…¨ç¨‹ï¼", type: "end"}
        ];

        // è®¡ç®—ç´¯è®¡è·ç¦»
        function haversine(lat1, lon1, lat2, lon2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // è®¡ç®—æ¯ä¸ªç‚¹çš„ç´¯è®¡è·ç¦»
        var cumulativeDistance = 0;
        for (var i = 0; i < routePoints.length; i++) {
            if (i > 0) {
                cumulativeDistance += haversine(
                    routePoints[i-1].lat, routePoints[i-1].lng,
                    routePoints[i].lat, routePoints[i].lng
                );
            }
            routePoints[i].distance = cumulativeDistance;
        }

        // ç”Ÿæˆå…³é”®èŠ‚ç‚¹åˆ—è¡¨ï¼ˆæ¯5å…¬é‡Œä¸€ä¸ªï¼ŒåŒ…å«è¡¥ç»™ç‚¹å’Œåœ°æ ‡ï¼‰
        function generateCheckpoints() {
            var checkpointsList = document.getElementById('checkpointsList');
            var html = '';
            var lastCheckpointDist = 0;
            var checkpointNum = 0;
            
            // èµ·ç‚¹
            html += '<div class="checkpoint-item">' +
                '<div class="checkpoint-number">èµ·</div>' +
                '<div class="checkpoint-name">' + routePoints[0].name + '</div>' +
                '<div class="checkpoint-distance">0 km</div>' +
                '</div>';
            
            // åˆå¹¶è·¯çº¿ç‚¹å’Œå…³é”®ä½ç½®ï¼ŒæŒ‰è·ç¦»æ’åº
            var allCheckpoints = [];
            
            // æ·»åŠ æ¯5å…¬é‡Œçš„è·¯çº¿ç‚¹
            for (var i = 1; i < routePoints.length - 1; i++) {
                if (routePoints[i].distance - lastCheckpointDist >= 5) {
                    allCheckpoints.push({
                        distance: routePoints[i].distance,
                        name: routePoints[i].name,
                        type: 'route',
                        icon: null
                    });
                    lastCheckpointDist = routePoints[i].distance;
                }
            }
            
            // æ·»åŠ å…³é”®ä½ç½®ï¼ˆè¡¥ç»™ç‚¹å’Œåœ°æ ‡ï¼‰
            keyLocations.forEach(function(location) {
                if (location.distance !== null) {
                    var facilities = location.facilities.length > 0 
                        ? ' (' + location.facilities.join('ã€') + ')' 
                        : '';
                    allCheckpoints.push({
                        distance: location.distance,
                        name: location.name + facilities,
                        type: location.type,
                        icon: location.icon,
                        color: location.color
                    });
                }
            });
            
            // æŒ‰è·ç¦»æ’åº
            allCheckpoints.sort(function(a, b) {
                return a.distance - b.distance;
            });
            
            // ç”ŸæˆHTML
            checkpointNum = 0;
            allCheckpoints.forEach(function(checkpoint) {
                checkpointNum++;
                var itemStyle = '';
                var numberStyle = '';
                
                if (checkpoint.type === 'supply') {
                    itemStyle = 'style="background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%); border-left: 3px solid #FFA500;"';
                    numberStyle = 'style="background: #FFA500;"';
                } else if (checkpoint.type === 'landmark') {
                    itemStyle = 'style="background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%); border-left: 3px solid #9C27B0;"';
                    numberStyle = 'style="background: #9C27B0;"';
                }
                
                var iconHtml = checkpoint.icon ? checkpoint.icon + ' ' : '';
                
                html += '<div class="checkpoint-item" ' + itemStyle + '>' +
                    '<div class="checkpoint-number" ' + numberStyle + '>' + checkpointNum + '</div>' +
                    '<div class="checkpoint-name">' + iconHtml + checkpoint.name + '</div>' +
                    '<div class="checkpoint-distance">~' + checkpoint.distance.toFixed(1) + ' km</div>' +
                    '</div>';
            });
            
            // ç»ˆç‚¹
            var lastPoint = routePoints[routePoints.length - 1];
            html += '<div class="checkpoint-item">' +
                '<div class="checkpoint-number">ç»ˆ</div>' +
                '<div class="checkpoint-name">' + lastPoint.name + '</div>' +
                '<div class="checkpoint-distance">~' + lastPoint.distance.toFixed(1) + ' km</div>' +
                '</div>';
            
            checkpointsList.innerHTML = html;
        }

        generateCheckpoints();

        // åˆå§‹åŒ–åœ°å›¾
        var map = new BMap.Map("map");
        var centerPoint = new BMap.Point(116.32, 37.38); // å¾·å·å¸‚ä¸­å¿ƒ
        map.centerAndZoom(centerPoint, 12);
        map.enableScrollWheelZoom(true);

        // ç»˜åˆ¶è·¯çº¿
        var polylinePoints = [];
        routePoints.forEach(function(point) {
            polylinePoints.push(new BMap.Point(point.lng, point.lat));
        });

        var polyline = new BMap.Polyline(polylinePoints, {
            strokeColor: "#FF6B6B",
            strokeWeight: 4,
            strokeOpacity: 0.8
        });
        map.addOverlay(polyline);

        // æ·»åŠ èµ·ç‚¹å’Œç»ˆç‚¹æ ‡è®°ï¼ˆå¸¦åœ°å€ä¿¡æ¯ï¼‰
        var startPoint = new BMap.Point(routePoints[0].lng, routePoints[0].lat);
        var startIcon = new BMap.Icon("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='40'%3E%3Cpath d='M15,0 C6.7,0 0,6.7 0,15 C0,26.2 15,40 15,40 S30,26.2 30,15 C30,6.7 23.3,0 15,0 Z' fill='%2328a745'/%3E%3Ccircle cx='15' cy='15' r='8' fill='white'/%3E%3C/svg%3E", new BMap.Size(30, 40));
        
        var startLabelStyle = {
            color: "#28a745",
            fontSize: "14px",
            fontWeight: "bold",
            border: "none",
            backgroundColor: "white",
            padding: "5px 10px",
            borderRadius: "4px",
            boxShadow: "0 2px 6px rgba(0,0,0,0.2)"
        };
        
        var startMarker = addMarkerWithGeocode(startPoint, routePoints[0], startIcon, "èµ·ç‚¹/ç»ˆç‚¹", startLabelStyle);

        // åˆ›å»ºåœ°ç†ç¼–ç æœåŠ¡å®ä¾‹
        var geocoder = new BMap.Geocoder();
        
        // ä¸ºæ ‡è®°æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºè¯¦ç»†åœ°å€ä¿¡æ¯
        function addMarkerWithGeocode(point, pointData, icon, labelText, labelStyle) {
            var marker = new BMap.Marker(point, {icon: icon});
            
            if (labelText) {
                var label = new BMap.Label(labelText, {offset: new BMap.Size(0, -38)});
                label.setStyle(labelStyle);
                marker.setLabel(label);
            }
            
            // ç‚¹å‡»æ ‡è®°æ—¶è·å–è¯¦ç»†åœ°å€
            marker.addEventListener('click', function() {
                // æ˜¾ç¤ºåŠ è½½æç¤º
                var loadingWindow = new BMap.InfoWindow(
                    "<div style='padding:10px;text-align:center;'>â³ æ­£åœ¨è·å–åœ°å€ä¿¡æ¯...</div>",
                    {width: 250}
                );
                this.openInfoWindow(loadingWindow);
                
                // é€†åœ°ç†ç¼–ç è·å–åœ°å€
                geocoder.getLocation(point, function(result) {
                    if (result) {
                        var address = result.address;
                        var surroundingPois = result.surroundingPois || [];
                        var nearbyPoi = surroundingPois.length > 0 ? surroundingPois[0].title : '';
                        
                        var infoHtml = "<div style='padding:12px;max-width:350px;'>" +
                            "<h4 style='margin:0 0 10px 0;color:#FF6B6B;font-size:16px;'>" +
                            "ğŸ“ " + pointData.name + "</h4>" +
                            "<p style='margin:0 0 8px 0;color:#666;font-size:13px;line-height:1.6;'>" +
                            "<strong>æè¿°ï¼š</strong>" + pointData.desc + "</p>" +
                            "<p style='margin:0 0 8px 0;color:#666;font-size:13px;line-height:1.6;'>" +
                            "<strong>åœ°å€ï¼š</strong>" + address + "</p>";
                        
                        if (nearbyPoi) {
                            infoHtml += "<p style='margin:0 0 8px 0;color:#666;font-size:13px;'>" +
                                "<strong>é™„è¿‘ï¼š</strong>" + nearbyPoi + "</p>";
                        }
                        
                        infoHtml += "<p style='margin:0 0 4px 0;color:#999;font-size:12px;'>" +
                            "åæ ‡ï¼š" + pointData.lat.toFixed(6) + ", " + pointData.lng.toFixed(6) + "</p>";
                        
                        if (pointData.distance !== undefined) {
                            infoHtml += "<p style='margin:0;color:#FF6B6B;font-size:13px;font-weight:bold;'>" +
                                "ç´¯è®¡è·ç¦»ï¼š" + pointData.distance.toFixed(2) + " km</p>";
                        }
                        
                        infoHtml += "</div>";
                        
                        var infoWindow = new BMap.InfoWindow(infoHtml, {width: 370});
                        marker.openInfoWindow(infoWindow);
                    } else {
                        // å¦‚æœè·å–åœ°å€å¤±è´¥ï¼Œæ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                        var basicInfoHtml = "<div style='padding:12px;max-width:300px;'>" +
                            "<h4 style='margin:0 0 10px 0;color:#FF6B6B;font-size:16px;'>" +
                            "ğŸ“ " + pointData.name + "</h4>" +
                            "<p style='margin:0 0 8px 0;color:#666;font-size:13px;'>" +
                            "<strong>æè¿°ï¼š</strong>" + pointData.desc + "</p>" +
                            "<p style='margin:0 0 4px 0;color:#999;font-size:12px;'>" +
                            "åæ ‡ï¼š" + pointData.lat.toFixed(6) + ", " + pointData.lng.toFixed(6) + "</p>";
                        
                        if (pointData.distance !== undefined) {
                            basicInfoHtml += "<p style='margin:0;color:#FF6B6B;font-size:13px;font-weight:bold;'>" +
                                "ç´¯è®¡è·ç¦»ï¼š" + pointData.distance.toFixed(2) + " km</p>";
                        }
                        
                        basicInfoHtml += "</div>";
                        
                        var basicInfoWindow = new BMap.InfoWindow(basicInfoHtml, {width: 320});
                        marker.openInfoWindow(basicInfoWindow);
                    }
                });
            });
            
            map.addOverlay(marker);
            return marker;
        }
        
        // æ·»åŠ å…³é”®èŠ‚ç‚¹æ ‡è®°ï¼ˆæ¯10å…¬é‡Œï¼‰
        var lastMarkerDist = 0;
        for (var i = 1; i < routePoints.length - 1; i++) {
            if (routePoints[i].distance - lastMarkerDist >= 10) {
                var pt = new BMap.Point(routePoints[i].lng, routePoints[i].lat);
                var icon = new BMap.Icon("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='32'%3E%3Cpath d='M12,0 C5.4,0 0,5.4 0,12 C0,21 12,32 12,32 S24,21 24,12 C24,5.4 18.6,0 12,0 Z' fill='%23dc3545'/%3E%3Ccircle cx='12' cy='12' r='6' fill='white'/%3E%3C/svg%3E", new BMap.Size(24, 32));
                
                var labelStyle = {
                    color: "#dc3545",
                    fontSize: "12px",
                    border: "none",
                    backgroundColor: "white",
                    padding: "3px 8px",
                    borderRadius: "3px",
                    boxShadow: "0 1px 4px rgba(0,0,0,0.2)"
                };
                
                addMarkerWithGeocode(pt, routePoints[i], icon, routePoints[i].distance.toFixed(0) + "km", labelStyle);
                lastMarkerDist = routePoints[i].distance;
            }
        }

        // ä¸ºæ‰€æœ‰è·¯çº¿ç‚¹æ·»åŠ å°æ ‡è®°ï¼ˆå¯ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†åœ°å€ï¼‰
        console.log("æ·»åŠ æ‰€æœ‰è·¯çº¿ç‚¹æ ‡è®°...");
        for (var i = 0; i < routePoints.length; i++) {
            // è·³è¿‡å·²ç»æ·»åŠ çš„èµ·ç‚¹å’Œ10å…¬é‡Œæ ‡è®°ç‚¹
            if (i === 0) continue; // èµ·ç‚¹å·²æ·»åŠ 
            
            var shouldSkip = false;
            var checkDist = 0;
            for (var j = 1; j < i; j++) {
                if (routePoints[j].distance - checkDist >= 10) {
                    if (j === i) {
                        shouldSkip = true;
                        break;
                    }
                    checkDist = routePoints[j].distance;
                }
            }
            
            if (!shouldSkip) {
                var pt = new BMap.Point(routePoints[i].lng, routePoints[i].lat);
                // ä½¿ç”¨å°åœ†ç‚¹æ ‡è®°
                var smallIcon = new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12'%3E%3Ccircle cx='6' cy='6' r='5' fill='%23FF6B6B' stroke='white' stroke-width='1'/%3E%3C/svg%3E",
                    new BMap.Size(12, 12),
                    {anchor: new BMap.Size(6, 6)}
                );
                
                addMarkerWithGeocode(pt, routePoints[i], smallIcon, null, null);
            }
        }
        
        // ========== æ·»åŠ å…³é”®ä½ç½®æ ‡è®°ï¼ˆè¡¥ç»™ç‚¹å’Œåœ°æ ‡ï¼‰==========
        console.log("æ·»åŠ å…³é”®ä½ç½®æ ‡è®°...");
        
        // æ ¹æ®è·ç¦»æ‰¾åˆ°æœ€æ¥è¿‘çš„è·¯çº¿ç‚¹
        function findNearestPointByDistance(targetDistance) {
            var minDiff = Infinity;
            var nearestPoint = null;
            
            for (var i = 0; i < routePoints.length; i++) {
                var diff = Math.abs(routePoints[i].distance - targetDistance);
                if (diff < minDiff) {
                    minDiff = diff;
                    nearestPoint = routePoints[i];
                }
            }
            
            return nearestPoint;
        }
        
        // ä¸ºæ¯ä¸ªå…³é”®ä½ç½®æ·»åŠ æ ‡è®°
        keyLocations.forEach(function(location) {
            var targetPoint = null;
            
            // å¦‚æœæœ‰æŒ‡å®šè·ç¦»ï¼Œæ‰¾åˆ°æœ€æ¥è¿‘çš„è·¯çº¿ç‚¹
            if (location.distance !== null) {
                targetPoint = findNearestPointByDistance(location.distance);
            } else {
                // å¯¹äºå‡æ²³å¤§æ¡¥ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡åç§°æœç´¢æ¥å®šä½
                // æš‚æ—¶è·³è¿‡ï¼Œç¨åé€šè¿‡æœç´¢åŠŸèƒ½æ·»åŠ 
                return;
            }
            
            if (targetPoint) {
                var pt = new BMap.Point(targetPoint.lng, targetPoint.lat);
                
                // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡
                var iconSvg = location.type === 'supply' 
                    ? "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='42'%3E%3Cpath d='M16,0 C7.2,0 0,7.2 0,16 C0,28 16,42 16,42 S32,28 32,16 C32,7.2 24.8,0 16,0 Z' fill='" + encodeURIComponent(location.color) + "'/%3E%3Ccircle cx='16' cy='16' r='10' fill='white'/%3E%3Ctext x='16' y='21' text-anchor='middle' font-size='16' fill='" + encodeURIComponent(location.color) + "'%3E" + location.icon + "%3C/text%3E%3C/svg%3E"
                    : "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='42'%3E%3Cpath d='M16,0 C7.2,0 0,7.2 0,16 C0,28 16,42 16,42 S32,28 32,16 C32,7.2 24.8,0 16,0 Z' fill='" + encodeURIComponent(location.color) + "'/%3E%3Ccircle cx='16' cy='16' r='10' fill='white'/%3E%3Ctext x='16' y='21' text-anchor='middle' font-size='16' fill='" + encodeURIComponent(location.color) + "'%3E" + location.icon + "%3C/text%3E%3C/svg%3E";
                
                var keyIcon = new BMap.Icon(iconSvg, new BMap.Size(32, 42));
                var keyMarker = new BMap.Marker(pt, {icon: keyIcon});
                
                // æ·»åŠ æ ‡ç­¾
                var keyLabel = new BMap.Label(location.name, {offset: new BMap.Size(0, -48)});
                keyLabel.setStyle({
                    color: location.color,
                    fontSize: "13px",
                    fontWeight: "bold",
                    border: "2px solid " + location.color,
                    backgroundColor: "white",
                    padding: "4px 10px",
                    borderRadius: "4px",
                    boxShadow: "0 2px 8px rgba(0,0,0,0.3)"
                });
                keyMarker.setLabel(keyLabel);
                
                // åˆ›å»ºä¿¡æ¯çª—å£
                var facilitiesHtml = '';
                if (location.facilities.length > 0) {
                    facilitiesHtml = "<p style='margin:8px 0 0 0;color:#666;font-size:13px;'>" +
                        "<strong>è®¾æ–½ï¼š</strong>" + location.facilities.join("ã€") + "</p>";
                }
                
                var infoWindowHtml = "<div style='padding:12px;max-width:300px;'>" +
                    "<h4 style='margin:0 0 10px 0;color:" + location.color + ";font-size:16px;'>" +
                    location.icon + " " + location.name + "</h4>" +
                    "<p style='margin:0 0 8px 0;color:#666;font-size:14px;'>" +
                    location.description + "</p>" +
                    facilitiesHtml +
                    "<p style='margin:8px 0 0 0;color:#999;font-size:12px;'>" +
                    "è·ç¦»èµ·ç‚¹ï¼šçº¦ " + location.distance + " å…¬é‡Œ</p>" +
                    "</div>";
                
                var keyInfoWindow = new BMap.InfoWindow(infoWindowHtml, {width: 320});
                
                keyMarker.addEventListener('click', function() {
                    this.openInfoWindow(keyInfoWindow);
                });
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                keyMarker.setAnimation(BMAP_ANIMATION_BOUNCE);
                setTimeout(function() {
                    keyMarker.setAnimation(null);
                }, 2000);
                
                map.addOverlay(keyMarker);
                
                console.log("å·²æ·»åŠ å…³é”®ä½ç½®: " + location.name + " (" + location.distance + "km)");
            }
        });
        
        // æ·»åŠ è·ç¦»æ ‡å°º
        var distanceControl = new BMap.ScaleControl({anchor: BMAP_ANCHOR_BOTTOM_LEFT});
        map.addControl(distanceControl);

        // æ·»åŠ ç¼©æ”¾æ§ä»¶
        var navigationControl = new BMap.NavigationControl({anchor: BMAP_ANCHOR_TOP_RIGHT});
        map.addControl(navigationControl);

        // ========== åœ°ç‚¹æœç´¢åŠŸèƒ½ ==========
        var searchMarker = null;
        var localSearch = new BMap.LocalSearch(map, {
            onSearchComplete: function(results) {
                var resultsPanel = document.getElementById('searchResults');
                resultsPanel.innerHTML = '';
                
                if (localSearch.getStatus() == BMAP_STATUS_SUCCESS) {
                    var resultsHtml = '';
                    var resultsCount = Math.min(results.getCurrentNumPois(), 5);
                    
                    for (var i = 0; i < resultsCount; i++) {
                        var poi = results.getPoi(i);
                        resultsHtml += '<div class="search-result-item" data-index="' + i + '">' +
                            '<div class="search-result-title">' + poi.title + '</div>' +
                            '<div class="search-result-address">' + poi.address + '</div>' +
                            '</div>';
                    }
                    
                    resultsPanel.innerHTML = resultsHtml;
                    resultsPanel.style.display = 'block';
                    
                    var resultItems = resultsPanel.getElementsByClassName('search-result-item');
                    for (var i = 0; i < resultItems.length; i++) {
                        resultItems[i].addEventListener('click', function() {
                            var index = parseInt(this.getAttribute('data-index'));
                            var poi = results.getPoi(index);
                            showSearchResult(poi);
                            resultsPanel.style.display = 'none';
                        });
                    }
                } else {
                    resultsPanel.innerHTML = '<div class="search-result-item">æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</div>';
                    resultsPanel.style.display = 'block';
                }
            }
        });

        function showSearchResult(poi) {
            if (searchMarker) {
                map.removeOverlay(searchMarker);
            }
            
            var point = poi.point;
            var icon = new BMap.Icon(
                "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='42'%3E%3Cpath d='M16,0 C7.2,0 0,7.2 0,16 C0,28 16,42 16,42 S32,28 32,16 C32,7.2 24.8,0 16,0 Z' fill='%2300bcd4'/%3E%3Ccircle cx='16' cy='16' r='8' fill='white'/%3E%3C/svg%3E",
                new BMap.Size(32, 42)
            );
            
            searchMarker = new BMap.Marker(point, {icon: icon});
            map.addOverlay(searchMarker);
            
            var infoWindow = new BMap.InfoWindow(
                "<div style='padding:12px;max-width:300px;'>" +
                "<h4 style='margin:0 0 10px 0;color:#00bcd4;font-size:16px;'>" + poi.title + "</h4>" +
                "<p style='margin:0 0 8px 0;color:#666;font-size:14px;'><strong>åœ°å€ï¼š</strong>" + poi.address + "</p>" +
                (poi.phoneNumber ? "<p style='margin:0;color:#666;font-size:14px;'><strong>ç”µè¯ï¼š</strong>" + poi.phoneNumber + "</p>" : "") +
                "</div>",
                {width: 320}
            );
            
            searchMarker.openInfoWindow(infoWindow);
            map.centerAndZoom(point, 15);
            
            searchMarker.setAnimation(BMAP_ANIMATION_BOUNCE);
            setTimeout(function() {
                searchMarker.setAnimation(null);
            }, 2000);
        }

        document.getElementById('searchBtn').addEventListener('click', function() {
            var keyword = document.getElementById('searchInput').value.trim();
            if (keyword) {
                localSearch.search(keyword);
            } else {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
            }
        });

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        map.addEventListener('click', function() {
            document.getElementById('searchResults').style.display = 'none';
        });

        document.addEventListener('click', function(e) {
            var resultsPanel = document.getElementById('searchResults');
            var searchContainer = document.querySelector('.map-search-container');
            if (!resultsPanel.contains(e.target) && !searchContainer.contains(e.target)) {
                resultsPanel.style.display = 'none';
            }
        });

        // ========== å¤šäººä½ç½®å…±äº«åŠŸèƒ½ ==========
        var isSharing = false;
        var myUserId = null;
        var myNickname = null;
        var otherUsersMarkers = {};
        var userColors = {};
        var availableColors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788'
        ];
        var colorIndex = 0;

        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function getUserColor(userId) {
            if (!userColors[userId]) {
                userColors[userId] = availableColors[colorIndex % availableColors.length];
                colorIndex++;
            }
            return userColors[userId];
        }

        function createOtherUserIcon(color, heading) {
            if (heading !== null && heading !== undefined && !isNaN(heading)) {
                return new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36'%3E%3Ccircle cx='18' cy='18' r='16' fill='" + encodeURIComponent(color) + "' opacity='0.3'/%3E%3Ccircle cx='18' cy='18' r='10' fill='" + encodeURIComponent(color) + "'/%3E%3Ccircle cx='18' cy='18' r='5' fill='white'/%3E%3Cpath d='M 18 6 L 22 14 L 18 12 L 14 14 Z' fill='white' transform='rotate(" + heading + " 18 18)'/%3E%3C/svg%3E",
                    new BMap.Size(36, 36),
                    {anchor: new BMap.Size(18, 18)}
                );
            } else {
                return new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='36' height='36'%3E%3Ccircle cx='18' cy='18' r='16' fill='" + encodeURIComponent(color) + "' opacity='0.3'/%3E%3Ccircle cx='18' cy='18' r='10' fill='" + encodeURIComponent(color) + "'/%3E%3Ccircle cx='18' cy='18' r='5' fill='white'/%3E%3C/svg%3E",
                    new BMap.Size(36, 36),
                    {anchor: new BMap.Size(18, 18)}
                );
            }
        }

        function updateOnlineUsersList(users) {
            var userList = document.getElementById('userList');
            var userCount = document.getElementById('userCount');
            var onlineUsersDiv = document.getElementById('onlineUsers');
            
            var count = 0;
            var html = '';
            
            for (var userId in users) {
                if (userId === myUserId) continue;
                
                var user = users[userId];
                var color = getUserColor(userId);
                count++;
                
                var distance = '';
                if (lastPosition && user.lat && user.lng) {
                    var userPoint = new BMap.Point(user.lng, user.lat);
                    var myPoint = new BMap.Point(lastPosition.lng, lastPosition.lat);
                    var dist = map.getDistance(userPoint, myPoint);
                    if (dist < 1000) {
                        distance = Math.round(dist) + 'm';
                    } else {
                        distance = (dist / 1000).toFixed(1) + 'km';
                    }
                }
                
                html += '<div class="user-item">' +
                    '<div class="user-color" style="background: ' + color + ';"></div>' +
                    '<div class="user-name">' + (user.nickname || 'åŒ¿åç”¨æˆ·') + '</div>' +
                    (distance ? '<div class="user-distance">' + distance + '</div>' : '') +
                    '</div>';
            }
            
            userCount.textContent = count;
            userList.innerHTML = html || '<div style="text-align:center;color:#999;padding:10px;">æš‚æ— å…¶ä»–ç”¨æˆ·åœ¨çº¿</div>';
            onlineUsersDiv.style.display = isSharing ? 'block' : 'none';
        }

        function updateOtherUserMarker(userId, userData) {
            if (userId === myUserId) return;
            
            var point = new BMap.Point(userData.lng, userData.lat);
            var color = getUserColor(userId);
            
            if (otherUsersMarkers[userId]) {
                if (otherUsersMarkers[userId].marker) {
                    map.removeOverlay(otherUsersMarkers[userId].marker);
                }
                if (otherUsersMarkers[userId].circle) {
                    map.removeOverlay(otherUsersMarkers[userId].circle);
                }
                if (otherUsersMarkers[userId].label) {
                    map.removeOverlay(otherUsersMarkers[userId].label);
                }
            }
            
            var icon = createOtherUserIcon(color, userData.heading);
            var marker = new BMap.Marker(point, {icon: icon});
            
            // æ ¹æ®å®šä½è´¨é‡è°ƒæ•´åœ†åœˆæ ·å¼
            var accuracy = userData.accuracy || 50;
            var quality = assessLocationQuality(accuracy);
            
            var circle = new BMap.Circle(point, accuracy, {
                strokeColor: quality.color,
                strokeWeight: 2,
                strokeOpacity: 0.4,
                fillColor: quality.color,
                fillOpacity: 0.15
            });
            
            var label = new BMap.Label(userData.nickname || 'åŒ¿å', {
                offset: new BMap.Size(0, -40)
            });
            label.setStyle({
                color: color,
                fontSize: '12px',
                fontWeight: 'bold',
                border: 'none',
                backgroundColor: 'white',
                padding: '3px 8px',
                borderRadius: '3px',
                boxShadow: '0 1px 4px rgba(0,0,0,0.2)'
            });
            
            marker.setLabel(label);
            
            var speedKmh = userData.speed ? (userData.speed * 3.6).toFixed(1) : '0.0';
            var locationType = userData.locationType || 'æœªçŸ¥';
            var qualityText = userData.quality || quality.text;
            
            var infoWindow = new BMap.InfoWindow(
                "<div style='padding:10px;'>" +
                "<h4 style='margin:0 0 8px 0;color:" + color + ";'>ğŸ‘¤ " + (userData.nickname || 'åŒ¿åç”¨æˆ·') + "</h4>" +
                "<p style='margin:0;font-size:13px;color:#666;'>é€Ÿåº¦ï¼š" + speedKmh + " km/h</p>" +
                (userData.heading ? "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>æ–¹å‘ï¼š" + Math.round(userData.heading) + "Â°</p>" : "") +
                "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>ç²¾åº¦ï¼šÂ±" + Math.round(accuracy) + "ç±³ " + quality.emoji + "</p>" +
                "<p style='margin:4px 0 0 0;font-size:13px;color:" + quality.color + ";'><strong>å®šä½è´¨é‡ï¼š" + qualityText + "</strong></p>" +
                "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>å®šä½æ–¹å¼ï¼š" + locationType + "</p>" +
                "<p style='margin:4px 0 0 0;font-size:13px;color:#999;'>æ›´æ–°ï¼š" + new Date(userData.timestamp).toLocaleTimeString() + "</p>" +
                "</div>",
                {width: 250}
            );
            
            marker.addEventListener('click', function() {
                this.openInfoWindow(infoWindow);
            });
            
            map.addOverlay(marker);
            map.addOverlay(circle);
            
            otherUsersMarkers[userId] = {marker: marker, circle: circle, label: label};
        }

        function removeUserMarker(userId) {
            if (otherUsersMarkers[userId]) {
                if (otherUsersMarkers[userId].marker) {
                    map.removeOverlay(otherUsersMarkers[userId].marker);
                }
                if (otherUsersMarkers[userId].circle) {
                    map.removeOverlay(otherUsersMarkers[userId].circle);
                }
                delete otherUsersMarkers[userId];
            }
        }

        function startSharing() {
            if (!isFirebaseEnabled) {
                alert('âŒ Firebase æœªé…ç½®ï¼Œæ— æ³•ä½¿ç”¨å¤šäººå…±äº«åŠŸèƒ½ã€‚\n\nè¯·æŒ‰ç…§ FIREBASE_SETUP.md ä¸­çš„è¯´æ˜é…ç½® Firebaseã€‚');
                return;
            }
            
            var nickname = document.getElementById('nicknameInput').value.trim();
            if (!nickname) {
                alert('è¯·è¾“å…¥ä½ çš„æ˜µç§°');
                document.getElementById('nicknameInput').focus();
                return;
            }
            
            myUserId = generateUserId();
            myNickname = nickname;
            isSharing = true;
            
            var shareBtn = document.getElementById('shareBtn');
            shareBtn.textContent = 'ğŸ”´ åœæ­¢å…±äº«';
            shareBtn.classList.add('active');
            document.getElementById('nicknameInput').disabled = true;
            
            database.ref('users').on('value', function(snapshot) {
                var users = snapshot.val() || {};
                updateOnlineUsersList(users);
                
                for (var userId in users) {
                    updateOtherUserMarker(userId, users[userId]);
                }
                
                for (var userId in otherUsersMarkers) {
                    if (!users[userId]) {
                        removeUserMarker(userId);
                    }
                }
            });
            
            database.ref('users/' + myUserId).onDisconnect().remove();
            
            if (!isTracking) {
                document.getElementById('locationBtn').click();
            }
        }

        function stopSharing() {
            if (!isFirebaseEnabled || !myUserId) return;
            
            isSharing = false;
            
            database.ref('users/' + myUserId).remove();
            database.ref('users').off();
            
            for (var userId in otherUsersMarkers) {
                removeUserMarker(userId);
            }
            otherUsersMarkers = {};
            
            var shareBtn = document.getElementById('shareBtn');
            shareBtn.textContent = 'ğŸŒ å¼€å§‹å…±äº«ä½ç½®';
            shareBtn.classList.remove('active');
            document.getElementById('nicknameInput').disabled = false;
            document.getElementById('onlineUsers').style.display = 'none';
            
            myUserId = null;
            myNickname = null;
        }

        function updateMyLocationToFirebase(lat, lng, accuracy, speed, heading) {
            if (!isSharing || !myUserId || !isFirebaseEnabled) return;
            
            database.ref('users/' + myUserId).set({
                nickname: myNickname,
                lat: lat,
                lng: lng,
                accuracy: accuracy,
                speed: speed || 0,
                heading: heading || 0,
                timestamp: Date.now()
            });
        }

        if (isFirebaseEnabled) {
            database.ref('.info/connected').on('value', function(snapshot) {
                var statusDiv = document.getElementById('firebaseStatus');
                if (snapshot.val() === true) {
                    statusDiv.textContent = 'âœ… æœåŠ¡å™¨å·²è¿æ¥';
                    statusDiv.className = 'firebase-status connected';
                } else {
                    statusDiv.textContent = 'âŒ æœåŠ¡å™¨è¿æ¥æ–­å¼€';
                    statusDiv.className = 'firebase-status error';
                }
            });
        } else {
            var statusDiv = document.getElementById('firebaseStatus');
            statusDiv.textContent = 'âš ï¸ Firebase æœªé…ç½®ï¼Œè¯·æŸ¥çœ‹ FIREBASE_SETUP.md';
            statusDiv.className = 'firebase-status error';
        }

        document.getElementById('shareBtn').addEventListener('click', function() {
            if (isSharing) {
                stopSharing();
            } else {
                startSharing();
            }
        });

        // ========== å®æ—¶å®šä½åŠŸèƒ½ï¼ˆå¢å¼ºç‰ˆï¼‰==========
        var locationMarker = null;
        var locationCircle = null;
        var watchId = null;
        var isTracking = false;
        var lastPosition = null;
        var currentHeading = 0;
        var geolocation = null; // ç™¾åº¦åœ°å›¾å®šä½å¯¹è±¡
        var positionHistory = []; // ä½ç½®å†å²è®°å½•ï¼Œç”¨äºå¹³æ»‘å¤„ç†
        var maxHistorySize = 5; // ä¿ç•™æœ€è¿‘5ä¸ªä½ç½®ç”¨äºå¹³æ»‘
        var lastUpdateTime = 0; // ä¸Šæ¬¡æ›´æ–°æ—¶é—´
        var minUpdateInterval = 1000; // æœ€å°æ›´æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰

        // åˆå§‹åŒ–ç™¾åº¦åœ°å›¾å®šä½æœåŠ¡
        function initBaiduGeolocation() {
            geolocation = new BMap.Geolocation();
            console.log('âœ… ç™¾åº¦åœ°å›¾å®šä½æœåŠ¡å·²åˆå§‹åŒ–');
        }

        // ä½ç½®å¹³æ»‘ç®—æ³• - ä½¿ç”¨åŠ æƒå¹³å‡
        function smoothPosition(newLat, newLng, accuracy) {
            // å¦‚æœç²¾åº¦å¤ªå·®ï¼ˆ>100ç±³ï¼‰ï¼Œæƒé‡é™ä½
            var weight = accuracy > 100 ? 0.3 : (accuracy > 50 ? 0.5 : 0.7);
            
            positionHistory.push({
                lat: newLat,
                lng: newLng,
                accuracy: accuracy,
                weight: weight,
                timestamp: Date.now()
            });

            // åªä¿ç•™æœ€è¿‘çš„Nä¸ªä½ç½®
            if (positionHistory.length > maxHistorySize) {
                positionHistory.shift();
            }

            // å¦‚æœå†å²è®°å½•å°‘äº2ä¸ªï¼Œç›´æ¥è¿”å›å½“å‰ä½ç½®
            if (positionHistory.length < 2) {
                return {lat: newLat, lng: newLng};
            }

            // è®¡ç®—åŠ æƒå¹³å‡
            var totalWeight = 0;
            var weightedLat = 0;
            var weightedLng = 0;

            positionHistory.forEach(function(pos) {
                weightedLat += pos.lat * pos.weight;
                weightedLng += pos.lng * pos.weight;
                totalWeight += pos.weight;
            });

            return {
                lat: weightedLat / totalWeight,
                lng: weightedLng / totalWeight
            };
        }

        // è¯„ä¼°å®šä½è´¨é‡
        function assessLocationQuality(accuracy) {
            if (accuracy <= 10) {
                return {level: 'excellent', text: 'ä¼˜ç§€', color: '#28a745', emoji: 'ğŸŸ¢'};
            } else if (accuracy <= 30) {
                return {level: 'good', text: 'è‰¯å¥½', color: '#17a2b8', emoji: 'ğŸ”µ'};
            } else if (accuracy <= 50) {
                return {level: 'fair', text: 'ä¸€èˆ¬', color: '#ffc107', emoji: 'ğŸŸ¡'};
            } else if (accuracy <= 100) {
                return {level: 'poor', text: 'è¾ƒå·®', color: '#fd7e14', emoji: 'ğŸŸ '};
            } else {
                return {level: 'bad', text: 'å¾ˆå·®', color: '#dc3545', emoji: 'ğŸ”´'};
            }
        }

        function createLocationIcon(heading) {
            if (heading !== null && heading !== undefined && !isNaN(heading)) {
                return new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%234285f4;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%231a73e8;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='20' cy='20' r='18' fill='%234285f4' opacity='0.2'/%3E%3Ccircle cx='20' cy='20' r='12' fill='url(%23grad)'/%3E%3Ccircle cx='20' cy='20' r='6' fill='white'/%3E%3Cpath d='M 20 8 L 24 16 L 20 14 L 16 16 Z' fill='white' transform='rotate(" + heading + " 20 20)'/%3E%3C/svg%3E",
                    new BMap.Size(40, 40),
                    {anchor: new BMap.Size(20, 20)}
                );
            } else {
                return new BMap.Icon(
                    "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%234285f4;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%231a73e8;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='20' cy='20' r='18' fill='%234285f4' opacity='0.2'/%3E%3Ccircle cx='20' cy='20' r='12' fill='url(%23grad)'/%3E%3Ccircle cx='20' cy='20' r='6' fill='white'/%3E%3C/svg%3E",
                    new BMap.Size(40, 40),
                    {anchor: new BMap.Size(20, 20)}
                );
            }
        }

        function calculateHeading(lat1, lng1, lat2, lng2) {
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var lat1Rad = lat1 * Math.PI / 180;
            var lat2Rad = lat2 * Math.PI / 180;
            
            var y = Math.sin(dLng) * Math.cos(lat2Rad);
            var x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
                    Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
            
            var heading = Math.atan2(y, x) * 180 / Math.PI;
            return (heading + 360) % 360;
        }

        function calculateDistanceToRoute(lat, lng) {
            var userPoint = new BMap.Point(lng, lat);
            var minDistance = Infinity;
            var nearestPoint = null;

            routePoints.forEach(function(point) {
                var routePoint = new BMap.Point(point.lng, point.lat);
                var distance = map.getDistance(userPoint, routePoint);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestPoint = point;
                }
            });

            return {
                distance: Math.round(minDistance),
                nearestPoint: nearestPoint
            };
        }

        function updateLocationInfo(position, accuracy, routeInfo, speed, heading, locationType) {
            var infoPanel = document.getElementById('locationInfo');
            var distanceText = routeInfo.distance < 1000 
                ? routeInfo.distance + 'ç±³' 
                : (routeInfo.distance / 1000).toFixed(2) + 'å…¬é‡Œ';
            
            var statusEmoji = routeInfo.distance < 100 ? 'âœ…' : routeInfo.distance < 500 ? 'âš ï¸' : 'âŒ';
            var statusText = routeInfo.distance < 100 
                ? 'åœ¨è·¯çº¿ä¸Š' 
                : routeInfo.distance < 500 
                ? 'æ¥è¿‘è·¯çº¿' 
                : 'åç¦»è·¯çº¿';

            var paceText = '';
            if (speed && speed > 0.5) {
                var kmPerHour = speed * 3.6;
                var minPerKm = 60 / kmPerHour;
                var paceMin = Math.floor(minPerKm);
                var paceSec = Math.round((minPerKm - paceMin) * 60);
                paceText = '<br>ğŸƒ é…é€Ÿï¼š' + paceMin + '\'' + (paceSec < 10 ? '0' : '') + paceSec + '"/km';
            }

            var directionText = '';
            if (heading !== null && heading !== undefined && !isNaN(heading)) {
                var directions = ['åŒ—', 'ä¸œåŒ—', 'ä¸œ', 'ä¸œå—', 'å—', 'è¥¿å—', 'è¥¿', 'è¥¿åŒ—'];
                var index = Math.round(heading / 45) % 8;
                directionText = '<br>ğŸ§­ æ–¹å‘ï¼š' + directions[index] + ' (' + Math.round(heading) + 'Â°)';
            }

            // å®šä½è´¨é‡è¯„ä¼°
            var quality = assessLocationQuality(accuracy);
            var qualityText = '<br>' + quality.emoji + ' å®šä½è´¨é‡ï¼š' + quality.text;

            // å®šä½ç±»å‹è¯´æ˜
            var typeText = locationType ? '<br>ğŸ“¡ å®šä½æ–¹å¼ï¼š' + locationType : '';

            infoPanel.innerHTML = 
                '<strong>' + statusEmoji + ' ' + statusText + '</strong><br>' +
                'ğŸ“ æœ€è¿‘èŠ‚ç‚¹ï¼š' + routeInfo.nearestPoint.name + '<br>' +
                'ğŸ“ è·ç¦»è·¯çº¿ï¼š' + distanceText +
                paceText +
                directionText +
                qualityText +
                typeText +
                '<br><span class="location-accuracy">å®šä½ç²¾åº¦ï¼šÂ±' + Math.round(accuracy) + 'ç±³</span>';
            infoPanel.classList.add('show');
        }

        // ä½¿ç”¨ç™¾åº¦åœ°å›¾å®šä½ï¼ˆä¼˜å…ˆï¼‰
        function getBaiduLocation() {
            if (!geolocation) {
                initBaiduGeolocation();
            }

            geolocation.getCurrentPosition(function(r) {
                if (this.getStatus() == BMAP_STATUS_SUCCESS) {
                    var lat = r.point.lat;
                    var lng = r.point.lng;
                    var accuracy = r.accuracy || 50; // ç™¾åº¦å®šä½ç²¾åº¦
                    
                    // å®šä½ç±»å‹
                    var locationType = 'ç™¾åº¦å®šä½';
                    if (r.locationType) {
                        switch(r.locationType) {
                            case 1: locationType = 'GPSå®šä½'; break;
                            case 2: locationType = 'WiFiå®šä½'; break;
                            case 3: locationType = 'åŸºç«™å®šä½'; break;
                            case 4: locationType = 'IPå®šä½'; break;
                            default: locationType = 'æ··åˆå®šä½';
                        }
                    }

                    console.log('âœ… ç™¾åº¦å®šä½æˆåŠŸ:', locationType, 'ç²¾åº¦:', accuracy + 'm');
                    
                    // åº”ç”¨ä½ç½®å¹³æ»‘
                    var smoothed = smoothPosition(lat, lng, accuracy);
                    
                    processLocationUpdate(smoothed.lat, smoothed.lng, accuracy, null, null, locationType);
                } else {
                    console.warn('âš ï¸ ç™¾åº¦å®šä½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æµè§ˆå™¨å®šä½');
                    // ç™¾åº¦å®šä½å¤±è´¥ï¼Œä½¿ç”¨æµè§ˆå™¨å®šä½
                    useBrowserGeolocation();
                }
            }, {enableHighAccuracy: true});
        }

        // ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿå®šä½ï¼ˆå¤‡ç”¨ï¼‰
        function useBrowserGeolocation() {
            if (!navigator.geolocation) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½');
                stopTracking();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    var accuracy = position.coords.accuracy;
                    var speed = position.coords.speed;
                    var heading = position.coords.heading;

                    console.log('âœ… æµè§ˆå™¨å®šä½æˆåŠŸ, ç²¾åº¦:', accuracy + 'm');

                    // åº”ç”¨ä½ç½®å¹³æ»‘
                    var smoothed = smoothPosition(lat, lng, accuracy);
                    
                    processLocationUpdate(smoothed.lat, smoothed.lng, accuracy, speed, heading, 'GPSå®šä½');
                },
                function(error) {
                    onLocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        // å¤„ç†å®šä½æ›´æ–°ï¼ˆç»Ÿä¸€å¤„ç†å‡½æ•°ï¼‰
        function processLocationUpdate(lat, lng, accuracy, speed, heading, locationType) {
            var now = Date.now();
            
            // é™åˆ¶æ›´æ–°é¢‘ç‡ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„æ›´æ–°
            if (now - lastUpdateTime < minUpdateInterval) {
                return;
            }
            lastUpdateTime = now;

            var point = new BMap.Point(lng, lat);

            // è®¡ç®—æ–¹å‘
            if (lastPosition && speed && speed > 0.5) {
                var calculatedHeading = calculateHeading(
                    lastPosition.lat, 
                    lastPosition.lng, 
                    lat, 
                    lng
                );
                currentHeading = heading !== null && heading !== undefined && !isNaN(heading) 
                    ? heading 
                    : calculatedHeading;
            } else if (heading !== null && heading !== undefined && !isNaN(heading)) {
                currentHeading = heading;
            }

            lastPosition = {lat: lat, lng: lng};

            // æ›´æ–°åœ°å›¾æ ‡è®°
            if (locationMarker) {
                map.removeOverlay(locationMarker);
            }
            if (locationCircle) {
                map.removeOverlay(locationCircle);
            }

            var icon = createLocationIcon(currentHeading);
            locationMarker = new BMap.Marker(point, {icon: icon});
            map.addOverlay(locationMarker);

            // å®šä½è´¨é‡è¯„ä¼°ï¼Œè°ƒæ•´åœ†åœˆé¢œè‰²
            var quality = assessLocationQuality(accuracy);
            locationCircle = new BMap.Circle(point, accuracy, {
                strokeColor: quality.color,
                strokeWeight: 2,
                strokeOpacity: 0.5,
                fillColor: quality.color,
                fillOpacity: 0.15
            });
            map.addOverlay(locationCircle);

            var routeInfo = calculateDistanceToRoute(lat, lng);
            updateLocationInfo({coords: {latitude: lat, longitude: lng}}, accuracy, routeInfo, speed, currentHeading, locationType);
            updateMyLocationToFirebase(lat, lng, accuracy, speed, currentHeading);

            if (isTracking) {
                map.panTo(point);
            } else {
                map.centerAndZoom(point, 16);
            }

            // æ›´æ–°ä¿¡æ¯çª—å£
            var speedKmh = speed ? (speed * 3.6).toFixed(1) : '0.0';
            var quality = assessLocationQuality(accuracy);
            
            var infoWindow = new BMap.InfoWindow(
                "<div style='padding:10px;'>" +
                "<h4 style='margin:0 0 8px 0;color:#4285f4;'>ğŸ“ å½“å‰ä½ç½®</h4>" +
                "<p style='margin:0;font-size:13px;color:#666;'>çº¬åº¦ï¼š" + lat.toFixed(6) + "</p>" +
                "<p style='margin:0;font-size:13px;color:#666;'>ç»åº¦ï¼š" + lng.toFixed(6) + "</p>" +
                "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>ç²¾åº¦ï¼šÂ±" + Math.round(accuracy) + "ç±³ " + quality.emoji + "</p>" +
                "<p style='margin:4px 0 0 0;font-size:13px;color:" + quality.color + ";'><strong>å®šä½è´¨é‡ï¼š" + quality.text + "</strong></p>" +
                (locationType ? "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>å®šä½æ–¹å¼ï¼š" + locationType + "</p>" : "") +
                "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>é€Ÿåº¦ï¼š" + speedKmh + " km/h</p>" +
                (currentHeading ? "<p style='margin:4px 0 0 0;font-size:13px;color:#666;'>æ–¹å‘ï¼š" + Math.round(currentHeading) + "Â°</p>" : "") +
                "</div>",
                {width: 280}
            );

            locationMarker.addEventListener('click', function() {
                this.openInfoWindow(infoWindow);
            });
        }

        function onLocationError(error) {
            var errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šç”¨æˆ·æ‹’ç»äº†å®šä½è¯·æ±‚';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šè¯·æ±‚è¶…æ—¶';
                    break;
                default:
                    errorMsg = 'âŒ å®šä½å¤±è´¥ï¼šæœªçŸ¥é”™è¯¯';
            }
            
            var infoPanel = document.getElementById('locationInfo');
            infoPanel.innerHTML = '<strong>' + errorMsg + '</strong><br>' +
                '<span class="location-accuracy">è¯·ç¡®ä¿å·²å…è®¸æµè§ˆå™¨è®¿é—®ä½ç½®ä¿¡æ¯ï¼Œå¹¶å¼€å¯GPS</span>';
            infoPanel.classList.add('show');

            console.error('å®šä½é”™è¯¯:', error);
        }

        // å®šæ—¶æ›´æ–°å®šä½
        function startLocationUpdates() {
            // é¦–æ¬¡ç«‹å³è·å–ä½ç½®
            getBaiduLocation();
            
            // æ¯3ç§’æ›´æ–°ä¸€æ¬¡ä½ç½®
            watchId = setInterval(function() {
                if (isTracking) {
                    getBaiduLocation();
                }
            }, 3000);
        }

        function startTracking() {
            if (!navigator.geolocation && !geolocation) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½');
                return;
            }

            isTracking = true;
            positionHistory = []; // æ¸…ç©ºå†å²è®°å½•
            
            var locationBtn = document.getElementById('locationBtn');
            locationBtn.classList.add('active');
            locationBtn.innerHTML = 'ğŸ”´ åœæ­¢å®šä½';

            console.log('ğŸ¯ å¼€å§‹å®šä½è¿½è¸ª...');
            startLocationUpdates();
        }

        function stopTracking() {
            if (watchId !== null) {
                clearInterval(watchId);
                watchId = null;
            }

            isTracking = false;
            lastPosition = null;
            currentHeading = 0;
            positionHistory = [];
            
            var locationBtn = document.getElementById('locationBtn');
            locationBtn.classList.remove('active');
            locationBtn.innerHTML = 'ğŸ“ å®šä½';

            if (locationMarker) {
                map.removeOverlay(locationMarker);
                locationMarker = null;
            }
            if (locationCircle) {
                map.removeOverlay(locationCircle);
                locationCircle = null;
            }

            var infoPanel = document.getElementById('locationInfo');
            infoPanel.classList.remove('show');

            console.log('â¹ï¸ å®šä½è¿½è¸ªå·²åœæ­¢');
        }

        document.getElementById('locationBtn').addEventListener('click', function() {
            if (isTracking) {
                stopTracking();
            } else {
                startTracking();
            }
        });

        window.addEventListener('beforeunload', function() {
            if (isTracking) {
                stopTracking();
            }
        });
    </script>
</body>
</html>
